// Prisma Schema for OpenAero with Supabase Auth Integration
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// 用户与认证相关模型
// ============================================

// 用户扩展资料 - 扩展 Supabase Auth 用户
model UserProfile {
  id      String @id @default(uuid())
  user_id String @unique @map("user_id") // 关联到 auth.users.id

  // 个人资料
  first_name   String? @map("first_name")
  last_name    String? @map("last_name")
  display_name String? @map("display_name")
  avatar       String?
  bio          String?

  // 角色与权限
  roles       UserRole[] @default([USER])
  permissions String[]

  // 状态管理
  status         UserStatus @default(ACTIVE)
  is_blocked     Boolean    @default(false) @map("is_blocked")
  blocked_reason String?    @map("blocked_reason")
  blocked_at     DateTime?  @map("blocked_at")

  // 时间戳
  created_at    DateTime  @default(now()) @map("created_at")
  updated_at    DateTime  @updatedAt @map("updated_at")
  last_login_at DateTime? @map("last_login_at")

  // 关联关系
  creatorProfile CreatorProfile?
  orders         Order[]
  reviews        Review[]
  favorites      Favorite[]
  notifications  Notification[]
  carts          Cart[]
  productReviews ProductReview[]

  @@map("user_profiles")
}

// 创作者档案
model CreatorProfile {
  id          String        @id @default(cuid())
  user_id     String        @unique @map("user_id")
  bio         String?
  website     String?
  experience  String?
  specialties String[]
  status      CreatorStatus @default(PENDING)
  revenue     Decimal       @default(0) @db.Decimal(10, 2)
  created_at  DateTime      @default(now()) @map("created_at")
  updated_at  DateTime      @updatedAt @map("updated_at")

  // 关联关系
  user          UserProfile    @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  solutions     Solution[]
  revenueShares RevenueShare[]

  @@map("creator_profiles")
}

// ============================================
// 解决方案相关模型
// ============================================

model Solution {
  id          String         @id @default(cuid())
  title       String
  description String
  category    String
  price       Decimal        @db.Decimal(10, 2)
  status      SolutionStatus @default(DRAFT)
  images      String[]
  features    String[]
  tags        String[]
  locale      String         @default("zh-CN")
  specs       Json?
  bom         Json?

  // 创作者关联
  creator_id String @map("creator_id")

  // 版本控制
  version Int @default(1)

  // 审核相关
  submitted_at DateTime? @map("submitted_at")
  reviewed_at  DateTime? @map("reviewed_at")
  review_notes String?   @map("review_notes")

  // 发布相关
  published_at DateTime? @map("published_at")
  archived_at  DateTime? @map("archived_at")

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // 关联关系
  creator         CreatorProfile    @relation(fields: [creator_id], references: [id], onDelete: Cascade)
  versions        SolutionVersion[]
  files           SolutionFile[]
  solutionReviews SolutionReview[]
  orderSolutions  OrderSolution[]
  revenueShares   RevenueShare[]
  reviews         Review[]
  favorites       Favorite[]
  sampleOrders    SampleOrder[]
  products        Product[]

  @@map("solutions")
}

model SolutionVersion {
  id          String   @id @default(cuid())
  solution_id String   @map("solution_id")
  version     Int
  title       String
  description String
  category    String
  price       Decimal  @db.Decimal(10, 2)
  images      String[]
  features    String[]
  specs       Json?
  bom         Json?
  change_log  String?  @map("change_log")
  is_active   Boolean  @default(false) @map("is_active")
  created_by  String   @map("created_by")
  created_at  DateTime @default(now()) @map("created_at")

  solution Solution @relation(fields: [solution_id], references: [id], onDelete: Cascade)

  @@unique([solution_id, version])
  @@map("solution_versions")
}

model SolutionFile {
  id            String           @id @default(cuid())
  solution_id   String?          @map("solution_id")
  filename      String
  original_name String           @map("original_name")
  file_type     SolutionFileType @map("file_type")
  mime_type     String           @map("mime_type")
  size          Int
  path          String
  url           String
  thumbnail_url String?          @map("thumbnail_url")
  checksum      String
  metadata      Json?
  description   String?
  status        FileStatus       @default(ACTIVE)
  uploaded_by   String           @map("uploaded_by")
  created_at    DateTime         @default(now()) @map("created_at")
  updated_at    DateTime         @updatedAt @map("updated_at")

  solution Solution? @relation(fields: [solution_id], references: [id], onDelete: Cascade)

  @@map("solution_files")
}

model SolutionReview {
  id                String         @id @default(cuid())
  solution_id       String         @map("solution_id")
  reviewer_id       String         @map("reviewer_id")
  status            ReviewStatus
  score             Int?
  comments          String?
  quality_score     Int?           @map("quality_score")
  completeness      Int?
  innovation        Int?
  market_potential  Int?           @map("market_potential")
  decision          ReviewDecision
  decision_notes    String?        @map("decision_notes")
  suggestions       String[]
  review_started_at DateTime?      @map("review_started_at")
  reviewed_at       DateTime?      @map("reviewed_at")
  created_at        DateTime       @default(now()) @map("created_at")
  updated_at        DateTime       @updatedAt @map("updated_at")

  solution Solution @relation(fields: [solution_id], references: [id], onDelete: Cascade)

  @@map("solution_reviews")
}

// ============================================
// 订单与支付相关模型
// ============================================

model Order {
  id               String      @id @default(cuid())
  user_id          String      @map("user_id")
  status           OrderStatus @default(PENDING)
  total            Decimal     @db.Decimal(10, 2)
  order_number     String?     @unique @map("order_number")
  notes            String?
  shipping_address Json?       @map("shipping_address")
  billing_address  Json?       @map("billing_address")
  created_at       DateTime    @default(now()) @map("created_at")
  updated_at       DateTime    @updatedAt @map("updated_at")

  user                UserProfile          @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  orderSolutions      OrderSolution[]
  orderItems          OrderItem[]
  paymentTransactions PaymentTransaction[]
  revenueShares       RevenueShare[]
  productReviews      ProductReview[]

  @@map("orders")
}

model OrderSolution {
  id          String  @id @default(cuid())
  order_id    String  @map("order_id")
  solution_id String  @map("solution_id")
  quantity    Int     @default(1)
  price       Decimal @db.Decimal(10, 2)
  subtotal    Decimal @db.Decimal(10, 2)

  order    Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  solution Solution @relation(fields: [solution_id], references: [id], onDelete: Cascade)

  @@unique([order_id, solution_id])
  @@map("order_solutions")
}

model PaymentTransaction {
  id               String        @id @default(cuid())
  order_id         String        @map("order_id")
  payment_method   PaymentMethod @map("payment_method")
  payment_provider String        @map("payment_provider")
  amount           Decimal       @db.Decimal(10, 2)
  currency         String        @default("CNY")
  status           PaymentStatus @default(PENDING)
  external_id      String?       @map("external_id")
  external_status  String?       @map("external_status")
  paid_at          DateTime?     @map("paid_at")
  failure_reason   String?       @map("failure_reason")
  refund_amount    Decimal?      @map("refund_amount") @db.Decimal(10, 2)
  refunded_at      DateTime?     @map("refunded_at")
  metadata         Json?
  created_at       DateTime      @default(now()) @map("created_at")
  updated_at       DateTime      @updatedAt @map("updated_at")

  order         Order          @relation(fields: [order_id], references: [id], onDelete: Cascade)
  paymentEvents PaymentEvent[]

  @@map("payment_transactions")
}

model PaymentEvent {
  id                String           @id @default(cuid())
  payment_id        String           @map("payment_id")
  event_type        PaymentEventType @map("event_type")
  event_data        Json?            @map("event_data")
  external_event_id String?          @map("external_event_id")
  ip_address        String?          @map("ip_address")
  user_agent        String?          @map("user_agent")
  created_at        DateTime         @default(now()) @map("created_at")

  payment PaymentTransaction @relation(fields: [payment_id], references: [id], onDelete: Cascade)

  @@map("payment_events")
}

model RevenueShare {
  id               String        @id @default(cuid())
  order_id         String        @map("order_id")
  solution_id      String        @map("solution_id")
  creator_id       String        @map("creator_id")
  total_amount     Decimal       @map("total_amount") @db.Decimal(10, 2)
  platform_fee     Decimal       @map("platform_fee") @db.Decimal(10, 2)
  creator_revenue  Decimal       @map("creator_revenue") @db.Decimal(10, 2)
  status           RevenueStatus @default(PENDING)
  settled_at       DateTime?     @map("settled_at")
  withdrawn_at     DateTime?     @map("withdrawn_at")
  withdraw_method  String?       @map("withdraw_method")
  withdraw_account String?       @map("withdraw_account")
  created_at       DateTime      @default(now()) @map("created_at")
  updated_at       DateTime      @updatedAt @map("updated_at")

  order    Order          @relation(fields: [order_id], references: [id], onDelete: Cascade)
  solution Solution       @relation(fields: [solution_id], references: [id], onDelete: Cascade)
  creator  CreatorProfile @relation(fields: [creator_id], references: [id], onDelete: Cascade)

  @@unique([order_id, solution_id])
  @@map("revenue_shares")
}

// ============================================
// 评论与收藏
// ============================================

model Review {
  id          String   @id @default(cuid())
  user_id     String   @map("user_id")
  solution_id String   @map("solution_id")
  rating      Int
  comment     String?
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  user     UserProfile @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  solution Solution    @relation(fields: [solution_id], references: [id], onDelete: Cascade)

  @@unique([user_id, solution_id])
  @@map("reviews")
}

model Favorite {
  id          String   @id @default(cuid())
  user_id     String   @map("user_id")
  solution_id String   @map("solution_id")
  created_at  DateTime @default(now()) @map("created_at")

  user     UserProfile @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  solution Solution    @relation(fields: [solution_id], references: [id], onDelete: Cascade)

  @@unique([user_id, solution_id])
  @@map("favorites")
}

// ============================================
// 工厂与样品订单
// ============================================

model Factory {
  id            String        @id @default(cuid())
  name          String
  contact_name  String        @map("contact_name")
  contact_phone String?       @map("contact_phone")
  contact_email String?       @map("contact_email")
  address       String
  categories    String[]
  description   String?
  status        FactoryStatus @default(ACTIVE)
  capacity      Int?
  lead_time     Int?          @map("lead_time")
  min_order     Int?          @map("min_order")
  created_at    DateTime      @default(now()) @map("created_at")
  updated_at    DateTime      @updatedAt @map("updated_at")

  sampleOrders SampleOrder[]

  @@map("factories")
}

model SampleOrder {
  id             String            @id @default(cuid())
  factory_id     String            @map("factory_id")
  solution_id    String            @map("solution_id")
  order_number   String            @unique @map("order_number")
  quantity       Int
  deadline       DateTime
  status         SampleOrderStatus @default(PENDING)
  notes          String?
  requirements   Json?
  confirmed_at   DateTime?         @map("confirmed_at")
  started_at     DateTime?         @map("started_at")
  completed_at   DateTime?         @map("completed_at")
  delivered_at   DateTime?         @map("delivered_at")
  spec_files     String[]          @map("spec_files")
  result_files   String[]          @map("result_files")
  estimated_cost Decimal?          @map("estimated_cost") @db.Decimal(10, 2)
  actual_cost    Decimal?          @map("actual_cost") @db.Decimal(10, 2)
  created_at     DateTime          @default(now()) @map("created_at")
  updated_at     DateTime          @updatedAt @map("updated_at")

  factory  Factory  @relation(fields: [factory_id], references: [id], onDelete: Cascade)
  solution Solution @relation(fields: [solution_id], references: [id], onDelete: Cascade)

  @@map("sample_orders")
}

// ============================================
// 产品与库存
// ============================================

model ProductCategory {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  description      String?
  image            String?
  parent_id        String?  @map("parent_id")
  level            Int      @default(0)
  sort_order       Int      @default(0) @map("sort_order")
  is_active        Boolean  @default(true) @map("is_active")
  is_visible       Boolean  @default(true) @map("is_visible")
  meta_title       String?  @map("meta_title")
  meta_description String?  @map("meta_description")
  meta_keywords    String?  @map("meta_keywords")
  created_at       DateTime @default(now()) @map("created_at")
  updated_at       DateTime @updatedAt @map("updated_at")

  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parent_id], references: [id], onDelete: SetNull)
  children ProductCategory[] @relation("CategoryHierarchy")
  products Product[]

  @@map("product_categories")
}

model Product {
  id               String        @id @default(cuid())
  name             String
  slug             String        @unique
  description      String?
  short_desc       String?       @map("short_desc")
  sku              String        @unique
  barcode          String?
  brand            String?
  model            String?
  price            Decimal       @db.Decimal(10, 2)
  original_price   Decimal?      @map("original_price") @db.Decimal(10, 2)
  cost_price       Decimal?      @map("cost_price") @db.Decimal(10, 2)
  category_id      String        @map("category_id")
  weight           Decimal?      @db.Decimal(8, 3)
  dimensions       Json?
  color            String?
  material         String?
  images           String[]
  videos           String[]
  documents        String[]
  status           ProductStatus @default(DRAFT)
  is_active        Boolean       @default(true) @map("is_active")
  is_featured      Boolean       @default(false) @map("is_featured")
  meta_title       String?       @map("meta_title")
  meta_description String?       @map("meta_description")
  meta_keywords    String?       @map("meta_keywords")
  view_count       Int           @default(0) @map("view_count")
  sales_count      Int           @default(0) @map("sales_count")
  rating           Decimal?      @db.Decimal(3, 2)
  review_count     Int           @default(0) @map("review_count")
  solution_id      String?       @map("solution_id")
  created_at       DateTime      @default(now()) @map("created_at")
  updated_at       DateTime      @updatedAt @map("updated_at")

  category       ProductCategory   @relation(fields: [category_id], references: [id], onDelete: Restrict)
  solution       Solution?         @relation(fields: [solution_id], references: [id], onDelete: SetNull)
  inventory      ProductInventory?
  cartItems      CartItem[]
  orderItems     OrderItem[]
  productReviews ProductReview[]

  @@map("products")
}

model ProductInventory {
  id             String          @id @default(cuid())
  product_id     String          @unique @map("product_id")
  quantity       Int             @default(0)
  reserved       Int             @default(0)
  available      Int             @default(0)
  min_stock      Int             @default(0) @map("min_stock")
  max_stock      Int?            @map("max_stock")
  reorder_point  Int?            @map("reorder_point")
  reorder_qty    Int?            @map("reorder_qty")
  status         InventoryStatus @default(IN_STOCK)
  avg_cost       Decimal?        @map("avg_cost") @db.Decimal(10, 2)
  last_cost      Decimal?        @map("last_cost") @db.Decimal(10, 2)
  last_stock_in  DateTime?       @map("last_stock_in")
  last_stock_out DateTime?       @map("last_stock_out")
  created_at     DateTime        @default(now()) @map("created_at")
  updated_at     DateTime        @updatedAt @map("updated_at")

  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@map("product_inventory")
}

// ============================================
// 购物车
// ============================================

model Cart {
  id         String     @id @default(cuid())
  user_id    String     @map("user_id")
  status     CartStatus @default(ACTIVE)
  session_id String?    @map("session_id")
  created_at DateTime   @default(now()) @map("created_at")
  updated_at DateTime   @updatedAt @map("updated_at")

  user  UserProfile @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  items CartItem[]

  @@unique([user_id])
  @@map("carts")
}

model CartItem {
  id         String   @id @default(cuid())
  cart_id    String   @map("cart_id")
  product_id String   @map("product_id")
  quantity   Int
  unit_price Decimal  @map("unit_price") @db.Decimal(10, 2)
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  cart    Cart    @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([cart_id, product_id])
  @@map("cart_items")
}

model OrderItem {
  id          String   @id @default(cuid())
  order_id    String   @map("order_id")
  product_id  String   @map("product_id")
  quantity    Int
  unit_price  Decimal  @map("unit_price") @db.Decimal(10, 2)
  total_price Decimal  @map("total_price") @db.Decimal(10, 2)
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  order   Order   @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model ProductReview {
  id            String       @id @default(cuid())
  product_id    String       @map("product_id")
  user_id       String       @map("user_id")
  order_id      String?      @map("order_id")
  rating        Int
  title         String?
  content       String?
  images        String[]
  videos        String[]
  status        ReviewStatus @default(PENDING)
  is_verified   Boolean      @default(false) @map("is_verified")
  helpful_count Int          @default(0) @map("helpful_count")
  created_at    DateTime     @default(now()) @map("created_at")
  updated_at    DateTime     @updatedAt @map("updated_at")

  product Product     @relation(fields: [product_id], references: [id], onDelete: Cascade)
  user    UserProfile @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  order   Order?      @relation(fields: [order_id], references: [id], onDelete: SetNull)

  @@unique([product_id, user_id, order_id])
  @@map("product_reviews")
}

// ============================================
// 通知系统
// ============================================

model Notification {
  id              String               @id @default(cuid())
  type            NotificationType
  title           String
  message         String
  user_id         String               @map("user_id")
  action_url      String?              @map("action_url")
  metadata        Json?                @default("{}")
  priority        NotificationPriority @default(MEDIUM)
  channels        String[]
  scheduled_at    DateTime?            @map("scheduled_at")
  expires_at      DateTime?            @map("expires_at")
  read            Boolean              @default(false)
  read_at         DateTime?            @map("read_at")
  delivered       Boolean              @default(true)
  delivery_status Json?                @default("{}") @map("delivery_status")
  created_at      DateTime             @default(now()) @map("created_at")
  updated_at      DateTime             @updatedAt @map("updated_at")

  user UserProfile @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@map("notifications")
}

// ============================================
// 枚举类型
// ============================================

enum UserRole {
  USER
  CREATOR
  REVIEWER
  FACTORY_MANAGER
  ADMIN
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

enum CreatorStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum SolutionStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  PUBLISHED
  ARCHIVED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  PAYPAL
  BANK_TRANSFER
  ALIPAY
  WECHAT_PAY
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentEventType {
  CREATED
  INITIATED
  AUTHORIZED
  CAPTURED
  COMPLETED
  FAILED
  CANCELLED
  REFUND_INITIATED
  REFUND_COMPLETED
  REFUND_FAILED
  WEBHOOK_RECEIVED
  STATUS_CHANGED
}

enum RevenueStatus {
  PENDING
  AVAILABLE
  WITHDRAWN
  PROCESSING
}

enum FactoryStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SampleOrderStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  DELIVERED
  CANCELLED
}

enum SolutionFileType {
  IMAGE
  DOCUMENT
  CAD_FILE
  CODE
  SCHEMATIC
  PCB
  FIRMWARE
  MANUAL
  VIDEO
  OTHER
}

enum FileStatus {
  ACTIVE
  ARCHIVED
  DELETED
  PROCESSING
}

enum ReviewStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ReviewDecision {
  APPROVED
  REJECTED
  NEEDS_REVISION
  PENDING
}

enum ProductStatus {
  DRAFT
  PENDING
  APPROVED
  PUBLISHED
  ARCHIVED
  DISCONTINUED
}

enum InventoryStatus {
  IN_STOCK
  LOW_STOCK
  OUT_OF_STOCK
  DISCONTINUED
  RESERVED
}

enum CartStatus {
  ACTIVE
  ABANDONED
  CONVERTED
  EXPIRED
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  REVIEW
  SYSTEM
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}
