// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 用户认证与权限系统 (基于 Supabase Auth)
// ============================================

// 用户资料模型 - 扩展 Supabase Auth 用户数据
// 注意: auth.users 由 Supabase 管理，此表仅存储额外的用户资料信息
model UserProfile {
  id      String @id @default(uuid())
  user_id String @unique @map("user_id") // 引用 auth.users.id

  // 个人资料
  first_name   String? @map("first_name")
  last_name    String? @map("last_name")
  display_name String? @map("display_name")
  avatar       String?
  bio          String?

  // 角色与权限
  roles       UserRole[] @default([USER]) // 多角色数组（支持用户同时拥有多个角色）
  permissions String[] // 额外权限标识符数组

  // 状态管理
  status         UserStatus @default(ACTIVE)
  is_blocked     Boolean    @default(false) @map("is_blocked")
  blocked_reason String?    @map("blocked_reason")
  blocked_at     DateTime?  @map("blocked_at")

  // 时间戳
  created_at    DateTime  @default(now()) @map("created_at")
  updated_at    DateTime  @updatedAt @map("updated_at")
  last_login_at DateTime? @map("last_login_at")

  // 关联关系 (使用 user_id 关联)
  creatorProfile          CreatorProfile?
  addresses               UserAddress[]
  carts                   Cart[]
  notifications           Notification[]
  notificationPreferences NotificationPreference[]

  @@map("user_profiles")
}

// 用户角色枚举
enum UserRole {
  USER // 普通用户 - 可浏览和购买
  CREATOR // 创作者 - 可上传方案
  REVIEWER // 审核员 - 可审核方案
  FACTORY_MANAGER // 工厂管理员 - 管理工厂和试产
  ADMIN // 管理员 - 完全权限
  SUPER_ADMIN // 超级管理员 - 系统最高权限
}

// 用户状态枚举
enum UserStatus {
  ACTIVE // 活跃
  INACTIVE // 未激活
  SUSPENDED // 暂停
  DELETED // 已删除
}

// 创作者资料模型
model CreatorProfile {
  id      String @id @default(uuid())
  user_id String @unique @map("user_id")

  // 创作者信息
  company_name     String? @map("company_name")
  business_license String? @map("business_license")
  id_card          String? @map("id_card")
  tax_number       String? @map("tax_number")

  // 认证状态
  verification_status VerificationStatus @default(PENDING) @map("verification_status")
  verified_at         DateTime?          @map("verified_at")
  rejection_reason    String?            @map("rejection_reason")

  // 统计信息
  total_solutions Int      @default(0) @map("total_solutions")
  total_revenue   Decimal  @default(0) @map("total_revenue") @db.Decimal(15, 2)
  rating          Decimal? @db.Decimal(3, 2)

  // 银行账户信息（用于收益结算）
  bank_name         String? @map("bank_name")
  bank_account      String? @map("bank_account")
  bank_account_name String? @map("bank_account_name")

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // 关联关系
  userProfile UserProfile @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  solutions   Solution[] // 创作者创建的方案列表

  @@map("creator_profiles")
}

// 认证状态枚举
enum VerificationStatus {
  PENDING // 待审核
  APPROVED // 已通过
  REJECTED // 已拒绝
  EXPIRED // 已过期
}

// 用户地址模型
model UserAddress {
  id      String @id @default(uuid())
  user_id String @map("user_id")

  // 地址信息
  name        String
  phone       String
  province    String
  city        String
  district    String
  address     String
  postal_code String? @map("postal_code")

  // 地址类型
  is_default Boolean     @default(false) @map("is_default")
  type       AddressType @default(SHIPPING)

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // 关联关系
  userProfile UserProfile @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@map("user_addresses")
}

// 地址类型枚举
enum AddressType {
  SHIPPING // 收货地址
  BILLING // 账单地址
  BOTH // 两者都是
}

// 用户会话日志（用于安全审计）
model UserSession {
  id     String @id @default(cuid())
  userId String

  // 会话信息
  sessionToken String  @unique
  device       String? // 设备信息
  browser      String? // 浏览器信息
  os           String? // 操作系统
  ipAddress    String // IP地址
  location     String? // 地理位置

  // 时间信息
  loginAt        DateTime  @default(now())
  lastActivityAt DateTime  @default(now())
  logoutAt       DateTime?
  expiresAt      DateTime

  // 会话状态
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_sessions")
}

// 审计日志模型
model AuditLog {
  id String @id @default(cuid())

  // 操作信息
  userId     String? // 操作用户ID（可能为空，如系统操作）
  action     String // 操作类型
  resource   String // 资源类型
  resourceId String? // 资源ID

  // 操作详情
  oldValue Json? // 旧值
  newValue Json? // 新值
  metadata Json? // 额外元数据

  // 请求信息
  ipAddress String // IP地址
  userAgent String // User Agent

  // 结果
  success      Boolean @default(true)
  errorMessage String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
  @@map("audit_logs")
}

// 解决方案模型
model Solution {
  id             String         @id @default(cuid())
  title          String
  description    String
  summary        String?        @db.Text // 方案摘要
  category       String
  price          Decimal        @db.Decimal(10, 2)
  status         SolutionStatus @default(DRAFT)
  images         String[] // 图片URL数组
  features       String[] // 功能特性
  tags           String[] // 标签（独立于 features）
  locale         String         @default("zh-CN") // 语言
  specs          Json? // 技术规格JSON（保留向后兼容）
  technicalSpecs Json? // 技术规格JSON（新字段，与 specs 互斥使用）
  useCases       Json? // 应用场景
  architecture   Json? // 架构图
  bom            Json? // BOM清单JSON

  // 创作者关联
  creatorId String? // 创作者ID（关联到 CreatorProfile.id）

  // 版本控制
  version Int @default(1)

  // 审核相关
  submittedAt    DateTime? // 提交审核时间
  reviewedAt     DateTime? // 审核完成时间（保留向后兼容）
  lastReviewedAt DateTime? // 最后审核时间
  reviewNotes    String? // 审核备注

  // 发布相关
  publishedAt DateTime? // 发布时间
  archivedAt  DateTime? // 归档时间

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  creator         CreatorProfile?   @relation(fields: [creatorId], references: [id], onDelete: SetNull)
  orders          OrderSolution[]
  reviews         Review[]
  favorites       Favorite[]
  revenueShares   RevenueShare[]
  sampleOrders    SampleOrder[]
  files           SolutionFile[] // 方案文件
  products        Product[] // 基于此方案的商品
  solutionReviews SolutionReview[] // 方案审核记录
  versionHistory  SolutionVersion[] // 版本历史记录
  assets          SolutionAsset[] // 方案资产（图片、文档、视频、CAD）
  bomItems        SolutionBomItem[] // BOM清单项

  @@map("solutions")
}

// 方案版本历史模型
model SolutionVersion {
  id          String   @id @default(cuid())
  solutionId  String
  version     Int // 版本号
  title       String
  description String
  category    String
  price       Decimal  @db.Decimal(10, 2)
  images      String[] // 图片URL数组
  features    String[] // 功能特性
  specs       Json? // 技术规格JSON
  bom         Json? // BOM清单JSON

  // 版本元数据
  changeLog String? // 版本变更日志
  isActive  Boolean @default(false) // 是否为当前活跃版本

  // 创建信息
  createdBy String // 创建版本的用户ID
  createdAt DateTime @default(now())

  // 关联关系
  solution Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  @@unique([solutionId, version]) // 确保同一方案的版本号唯一
  @@map("solution_versions")
}

// 方案文件模型
model SolutionFile {
  id           String           @id @default(cuid())
  solutionId   String? // 可选，允许文件先上传后关联
  filename     String
  originalName String
  fileType     SolutionFileType
  mimeType     String
  size         Int // 文件大小(字节)
  path         String // 文件存储路径
  url          String // 文件访问URL
  thumbnailUrl String? // 缩略图URL(图片/PDF)
  checksum     String // 文件校验和

  // 文件元数据
  metadata    Json? // 文件元数据(尺寸、页数等)
  description String? // 文件描述

  // 状态管理
  status     FileStatus @default(ACTIVE)
  uploadedBy String // 上传者ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  solution Solution? @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  @@map("solution_files")
}

// 方案审核模型
model SolutionReview {
  id         String @id @default(cuid())
  solutionId String
  reviewerId String // 审核员ID

  // 状态转换记录（新增）
  fromStatus SolutionStatus // 审核前状态
  toStatus   SolutionStatus // 审核后状态

  // 审核内容
  status   ReviewStatus
  score    Int? // 审核评分(1-10)
  comments String? // 审核意见

  // 审核维度
  qualityScore    Int? // 质量评分(1-10)
  completeness    Int? // 完整性评分(1-10)
  innovation      Int? // 创新性评分(1-10)
  marketPotential Int? // 市场潜力评分(1-10)

  // 审核决策
  decision      ReviewDecision
  decisionNotes String? // 决策说明

  // 改进建议
  suggestions String[] // 改进建议列表

  // 时间记录
  reviewStartedAt DateTime? // 开始审核时间
  reviewedAt      DateTime? // 完成审核时间

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  solution Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  @@map("solution_reviews")
}

// 方案资产模型
model SolutionAsset {
  id         String   @id @default(cuid())
  solutionId String
  solution   Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  type        AssetType // 资产类型
  url         String // 资产URL
  title       String? // 资产标题
  description String? // 资产描述

  createdAt DateTime @default(now())

  @@map("solution_assets")
}

// 方案BOM清单项模型
model SolutionBomItem {
  id         String   @id @default(cuid())
  solutionId String
  solution   Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  // 基础信息
  name     String // 物料名称
  model    String? // 型号
  quantity Int     @default(1) // 数量
  unit     String? @default("个") // 数量单位（个、套、米、克等）
  notes    String? // 备注

  // 价格和成本
  unitPrice Decimal? @db.Decimal(10, 2) // 单价

  // 供应商信息
  supplier String? // 供应商名称

  // 零件标识
  partNumber   String? // 零件号/SKU
  manufacturer String? // 制造商

  // 分类和位置
  category String? // 物料类别（FRAME, MOTOR, ESC, PROPELLER, FLIGHT_CONTROLLER, BATTERY, CAMERA, GIMBAL, RECEIVER, TRANSMITTER, OTHER）
  position String? // 安装位置（机头、机尾、左臂、右臂等）

  // 物理属性
  weight Decimal? @db.Decimal(10, 3) // 重量（克）

  // 技术规格
  specifications Json? // 详细规格参数（JSON格式，可存储电压、电流、功率等）

  // 关联商城商品
  productId String? // 可关联商城商品ID（可选）
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@map("solution_bom_items")
}

// 订单模型
model Order {
  id     String      @id @default(cuid())
  status OrderStatus @default(PENDING)
  total  Decimal     @db.Decimal(10, 2)

  // 订单详情
  orderNumber String? @unique // 订单号
  notes       String? // 订单备注

  // 地址信息 (如果需要物流)
  shippingAddress Json? // 收货地址
  billingAddress  Json? // 账单地址

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  orderSolutions      OrderSolution[]
  orderItems          OrderItem[]
  paymentTransactions PaymentTransaction[]
  revenueShares       RevenueShare[]
  productReviews      ProductReview[]

  @@map("orders")
}

// 订单解决方案关联表 (订单项表)
model OrderSolution {
  id         String  @id @default(cuid())
  orderId    String
  solutionId String
  quantity   Int     @default(1)
  price      Decimal @db.Decimal(10, 2)
  subtotal   Decimal @db.Decimal(10, 2) // 小计 = quantity * price

  // 关联关系
  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  solution Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  @@unique([orderId, solutionId])
  @@map("order_solutions")
}

// 支付交易表
model PaymentTransaction {
  id              String        @id @default(cuid())
  orderId         String
  paymentMethod   PaymentMethod // 支付方式：支付宝、微信支付等
  paymentProvider String // 支付提供商：alipay、wechat
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("CNY")
  status          PaymentStatus @default(PENDING)

  // 第三方支付信息
  externalId     String? // 第三方支付订单号
  externalStatus String? // 第三方支付状态

  // 支付详情
  paidAt        DateTime? // 支付完成时间
  failureReason String? // 失败原因
  refundAmount  Decimal?  @db.Decimal(10, 2) // 退款金额
  refundedAt    DateTime? // 退款时间

  // 元数据
  metadata  Json? // 额外的支付信息
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  order         Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  paymentEvents PaymentEvent[]

  @@map("payment_transactions")
}

// 支付事件表 - 用于追踪支付状态变化
model PaymentEvent {
  id              String           @id @default(cuid())
  paymentId       String
  eventType       PaymentEventType // 事件类型
  eventData       Json? // 事件数据
  externalEventId String? // 第三方事件ID

  // 事件元数据
  ipAddress String? // 触发IP
  userAgent String? // 用户代理

  createdAt DateTime @default(now())

  // 关联关系
  payment PaymentTransaction @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@map("payment_events")
}

// 支付网关配置表
model PaymentGateway {
  id         String  @id @default(cuid())
  name       String // 网关名称
  provider   String // 提供商标识
  isActive   Boolean @default(true)
  isTestMode Boolean @default(true)

  // 配置信息
  config     Json // 网关配置
  webhookUrl String? // Webhook URL

  // 统计信息
  successCount Int     @default(0)
  failureCount Int     @default(0)
  totalAmount  Decimal @default(0) @db.Decimal(15, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payment_gateways")
}

// 收益分成表
model RevenueShare {
  id         String @id @default(cuid())
  orderId    String
  solutionId String
  creatorId  String

  // 收益计算
  totalAmount    Decimal @db.Decimal(10, 2) // 总金额
  platformFee    Decimal @db.Decimal(10, 2) // 平台费用 (50%)
  creatorRevenue Decimal @db.Decimal(10, 2) // 创作者收益 (50%)

  // 状态管理
  status    RevenueStatus @default(PENDING)
  settledAt DateTime? // 结算时间

  // 提现信息
  withdrawnAt     DateTime? // 提现时间
  withdrawMethod  String? // 提现方式
  withdrawAccount String? // 提现账户

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  order    Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  solution Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  @@unique([orderId, solutionId])
  @@map("revenue_shares")
}

// 评价模型
model Review {
  id         String   @id @default(cuid())
  userId     String
  solutionId String
  rating     Int // 1-5星评分
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // 关联关系
  solution Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  @@unique([userId, solutionId])
  @@map("reviews")
}

// 收藏模型
model Favorite {
  id         String   @id @default(cuid())
  userId     String
  solutionId String
  createdAt  DateTime @default(now())

  // 关联关系
  solution Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  @@unique([userId, solutionId])
  @@map("favorites")
}

// 用户会话模型
// 用户会话、邮箱验证、审计日志、文件模型已移除

// 工厂管理模型
model Factory {
  id           String        @id @default(cuid())
  name         String // 工厂名称
  contactName  String // 联系人姓名
  contactPhone String? // 联系电话
  contactEmail String? // 联系邮箱
  address      String // 工厂地址
  categories   String[] // 生产品类
  description  String? // 工厂描述
  status       FactoryStatus @default(ACTIVE)

  // 能力信息
  capacity Int? // 月产能
  leadTime Int? // 交期（天）
  minOrder Int? // 最小订单量

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  sampleOrders SampleOrder[]

  @@map("factories")
}

// 试产订单模型
model SampleOrder {
  id          String            @id @default(cuid())
  factoryId   String
  solutionId  String
  orderNumber String            @unique // 试产订单号
  quantity    Int // 试产数量
  deadline    DateTime // 截止时间
  status      SampleOrderStatus @default(PENDING)

  // 订单详情
  notes        String? // 订单备注
  requirements Json? // 特殊要求

  // 进度跟踪
  confirmedAt DateTime? // 确认时间
  startedAt   DateTime? // 开始生产时间
  completedAt DateTime? // 完成时间
  deliveredAt DateTime? // 交付时间

  // 文件管理
  specFiles   String[] // 规格文件URLs
  resultFiles String[] // 结果文件URLs

  // 成本信息
  estimatedCost Decimal? @db.Decimal(10, 2) // 预估成本
  actualCost    Decimal? @db.Decimal(10, 2) // 实际成本

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  factory  Factory  @relation(fields: [factoryId], references: [id], onDelete: Cascade)
  solution Solution @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  @@map("sample_orders")
}

// 商品分类模型
model ProductCategory {
  id          String  @id @default(cuid())
  name        String // 分类名称
  slug        String  @unique // URL友好的标识符
  description String? // 分类描述
  image       String? // 分类图片URL

  // 层级结构
  parentId  String? // 父分类ID
  level     Int     @default(0) // 分类层级
  sortOrder Int     @default(0) // 排序权重

  // 状态管理
  isActive  Boolean @default(true) // 是否启用
  isVisible Boolean @default(true) // 是否在前台显示

  // SEO信息
  metaTitle       String? // SEO标题
  metaDescription String? // SEO描述
  metaKeywords    String? // SEO关键词

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ProductCategory[] @relation("CategoryHierarchy")
  products Product[]

  @@map("product_categories")
}

// 商品模型
model Product {
  id          String  @id @default(cuid())
  name        String // 商品名称
  slug        String  @unique // URL友好的标识符
  description String? // 商品描述
  shortDesc   String? // 简短描述

  // 基础信息
  sku     String  @unique // 商品编码
  barcode String? // 条形码
  brand   String? // 品牌
  model   String? // 型号

  // 价格信息
  price         Decimal  @db.Decimal(10, 2) // 售价
  originalPrice Decimal? @db.Decimal(10, 2) // 原价
  costPrice     Decimal? @db.Decimal(10, 2) // 成本价

  // 分类关联
  categoryId String // 主分类ID

  // 商品属性
  weight     Decimal? @db.Decimal(8, 3) // 重量(kg)
  dimensions Json? // 尺寸信息 {length, width, height}
  color      String? // 颜色
  material   String? // 材质

  // 媒体资源
  images    String[] // 商品图片URLs
  videos    String[] // 商品视频URLs
  documents String[] // 相关文档URLs

  // 状态管理
  status     ProductStatus @default(DRAFT)
  isActive   Boolean       @default(true) // 是否启用
  isFeatured Boolean       @default(false) // 是否推荐

  // SEO信息
  metaTitle       String? // SEO标题
  metaDescription String? // SEO描述
  metaKeywords    String? // SEO关键词

  // 统计信息
  viewCount   Int      @default(0) // 浏览次数
  salesCount  Int      @default(0) // 销售次数
  rating      Decimal? @db.Decimal(3, 2) // 平均评分
  reviewCount Int      @default(0) // 评价数量

  // 关联方案（如果商品基于某个方案）
  solutionId String? // 关联的方案ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  category         ProductCategory   @relation(fields: [categoryId], references: [id])
  solution         Solution?         @relation(fields: [solutionId], references: [id])
  inventory        ProductInventory?
  cartItems        CartItem[]
  orderItems       OrderItem[]
  reviews          ProductReview[]
  solutionBomItems SolutionBomItem[] // BOM清单项关联

  @@map("products")
}

// 商品库存模型
model ProductInventory {
  id        String @id @default(cuid())
  productId String @unique // 商品ID

  // 库存数量
  quantity  Int @default(0) // 当前库存
  reserved  Int @default(0) // 预留库存
  available Int @default(0) // 可用库存

  // 库存阈值
  minStock     Int  @default(0) // 最低库存警戒线
  maxStock     Int? // 最高库存限制
  reorderPoint Int? // 补货点
  reorderQty   Int? // 补货数量

  // 库存状态
  status InventoryStatus @default(IN_STOCK)

  // 成本信息
  avgCost  Decimal? @db.Decimal(10, 2) // 平均成本
  lastCost Decimal? @db.Decimal(10, 2) // 最近成本

  // 时间记录
  lastStockIn  DateTime? // 最后入库时间
  lastStockOut DateTime? // 最后出库时间

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_inventory")
}

// 购物车模型
model Cart {
  id      String @id @default(uuid())
  user_id String @unique @map("user_id")

  // 购物车状态
  status CartStatus @default(ACTIVE)

  // 会话信息（用于未登录用户）
  session_id String? @map("session_id")

  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  // 关联关系
  userProfile UserProfile? @relation(fields: [user_id], references: [user_id])
  items       CartItem[]

  @@map("carts")
}

// 购物车项目模型
model CartItem {
  id        String @id @default(cuid())
  cartId    String // 购物车ID
  productId String // 商品ID
  quantity  Int // 数量

  // 价格快照（添加到购物车时的价格）
  unitPrice Decimal @db.Decimal(10, 2) // 单价

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId]) // 同一购物车中同一商品只能有一条记录
  @@map("cart_items")
}

// 订单项目模型（扩展现有订单系统）
model OrderItem {
  id        String @id @default(cuid())
  orderId   String // 订单ID
  productId String // 商品ID
  quantity  Int // 数量

  // 价格快照（下单时的价格）
  unitPrice  Decimal @db.Decimal(10, 2) // 单价
  totalPrice Decimal @db.Decimal(10, 2) // 小计

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

// 商品评价模型
model ProductReview {
  id        String  @id @default(cuid())
  productId String // 商品ID
  userId    String // 用户ID
  orderId   String? // 关联订单ID（确保用户购买过该商品）

  // 评价内容
  rating  Int // 评分(1-5)
  title   String? // 评价标题
  content String? // 评价内容

  // 媒体资源
  images String[] // 评价图片
  videos String[] // 评价视频

  // 状态管理
  status     ReviewStatus @default(PENDING) // 审核状态
  isVerified Boolean      @default(false) // 是否已验证购买

  // 互动统计
  helpfulCount Int @default(0) // 有用数

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联关系
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  order   Order?  @relation(fields: [orderId], references: [id])

  @@unique([productId, userId, orderId]) // 每个订单中每个商品只能评价一次
  @@map("product_reviews")
}

// 通知模型
model Notification {
  id              String               @id @default(uuid())
  type            NotificationType
  title           String
  message         String
  user_id         String               @map("user_id")
  action_url      String?              @map("action_url")
  metadata        Json?                @default("{}")
  priority        NotificationPriority @default(MEDIUM)
  channels        String[]
  scheduled_at    DateTime?            @map("scheduled_at")
  expires_at      DateTime?            @map("expires_at")
  read            Boolean              @default(false)
  read_at         DateTime?            @map("read_at")
  delivered       Boolean              @default(true)
  delivery_status Json?                @default("{}") @map("delivery_status")
  created_at      DateTime             @default(now()) @map("created_at")
  updated_at      DateTime             @updatedAt @map("updated_at")

  // 关联关系
  userProfile UserProfile? @relation(fields: [user_id], references: [user_id])

  @@map("notifications")
}

// 通知偏好模型
model NotificationPreference {
  id                      String   @id @default(uuid())
  user_id                 String   @unique @map("user_id")
  email_enabled           Boolean  @default(true) @map("email_enabled")
  push_enabled            Boolean  @default(true) @map("push_enabled")
  websocket_enabled       Boolean  @default(true) @map("websocket_enabled")
  review_notifications    Boolean  @default(true) @map("review_notifications")
  system_notifications    Boolean  @default(true) @map("system_notifications")
  marketing_notifications Boolean  @default(false) @map("marketing_notifications")
  quiet_hours_start       String?  @map("quiet_hours_start")
  quiet_hours_end         String?  @map("quiet_hours_end")
  timezone                String   @default("Asia/Shanghai")
  created_at              DateTime @default(now()) @map("created_at")
  updated_at              DateTime @updatedAt @map("updated_at")

  // 关联关系
  userProfile UserProfile? @relation(fields: [user_id], references: [user_id])

  @@map("notification_preferences")
}

// 协作会话模型
model CollaborationSession {
  id           String    @id @default(cuid())
  documentId   String // 文档ID
  documentType String // 文档类型 (solution, proposal, document)
  userId       String // 用户ID
  sessionId    String    @unique // 会话标识符
  joinedAt     DateTime  @default(now())
  lastActivity DateTime  @default(now())
  leftAt       DateTime? // 离开时间

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("collaboration_sessions")
}

// 协作操作模型
model CollaborationOperation {
  id          String   @id @default(cuid())
  documentId  String // 文档ID
  operationId String   @unique // 操作标识符
  type        String // 操作类型 (insert, delete, replace)
  position    Json // 操作位置 {line, column}
  content     String? // 插入/替换的内容
  length      Int? // 删除/替换的长度
  userId      String // 操作用户ID
  version     Int // 文档版本号
  timestamp   DateTime // 操作时间戳

  createdAt DateTime @default(now())

  @@map("collaboration_operations")
}

// 枚举类型
// 用户相关枚举已移除

enum SolutionStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  PUBLISHED
  ARCHIVED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  PAYPAL
  BANK_TRANSFER
  ALIPAY
  WECHAT_PAY
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentEventType {
  CREATED // 支付创建
  INITIATED // 支付发起
  AUTHORIZED // 支付授权
  CAPTURED // 支付捕获
  COMPLETED // 支付完成
  FAILED // 支付失败
  CANCELLED // 支付取消
  REFUND_INITIATED // 退款发起
  REFUND_COMPLETED // 退款完成
  REFUND_FAILED // 退款失败
  WEBHOOK_RECEIVED // Webhook接收
  STATUS_CHANGED // 状态变更
}

enum RevenueStatus {
  PENDING
  AVAILABLE
  WITHDRAWN
  PROCESSING
}

// 邮箱验证相关枚举已移除

enum FactoryStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SampleOrderStatus {
  PENDING // 待确认
  CONFIRMED // 已确认
  IN_PROGRESS // 生产中
  COMPLETED // 已完成
  DELIVERED // 已交付
  CANCELLED // 已取消
}

// 方案文件类型枚举
enum SolutionFileType {
  IMAGE // 图片文件
  DOCUMENT // 文档文件(PDF, DOC等)
  CAD_FILE // CAD文件(DWG, STEP等)
  CODE // 代码文件
  SCHEMATIC // 电路图
  PCB // PCB文件
  FIRMWARE // 固件文件
  MANUAL // 说明书
  VIDEO // 视频文件
  OTHER // 其他文件
}

// 方案资产类型枚举
enum AssetType {
  IMAGE
  DOCUMENT
  VIDEO
  CAD
  OTHER
}

// 文件状态枚举
enum FileStatus {
  ACTIVE // 活跃
  ARCHIVED // 已归档
  DELETED // 已删除
  PROCESSING // 处理中
}

// 审核状态枚举
enum ReviewStatus {
  PENDING // 待审核
  IN_PROGRESS // 审核中
  COMPLETED // 审核完成
  CANCELLED // 审核取消
}

// 审核决策枚举
enum ReviewDecision {
  APPROVED // 通过
  REJECTED // 拒绝
  NEEDS_REVISION // 需要修改
  PENDING // 待决策
}

// 商品状态枚举
enum ProductStatus {
  DRAFT // 草稿
  PENDING // 待审核
  APPROVED // 已审核
  PUBLISHED // 已发布
  ARCHIVED // 已归档
  DISCONTINUED // 已停产
}

// 库存状态枚举
enum InventoryStatus {
  IN_STOCK // 有库存
  LOW_STOCK // 库存不足
  OUT_OF_STOCK // 缺货
  DISCONTINUED // 停产
  RESERVED // 预留
}

// 购物车状态枚举
enum CartStatus {
  ACTIVE // 活跃
  ABANDONED // 已放弃
  CONVERTED // 已转换为订单
  EXPIRED // 已过期
}

// 通知类型枚举
enum NotificationType {
  INFO // 信息
  SUCCESS // 成功
  WARNING // 警告
  ERROR // 错误
  REVIEW // 审核
  SYSTEM // 系统
}

// 通知优先级枚举
enum NotificationPriority {
  LOW // 低
  MEDIUM // 中
  HIGH // 高
  URGENT // 紧急
}
