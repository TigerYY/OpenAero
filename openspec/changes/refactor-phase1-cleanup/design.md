# 阶段1代码清理和重构设计文档

## Context

项目经过多次重构，积累了技术债务。根据 `PROJECT_ASSESSMENT.md` 的评估，当前项目健康度评分为 6.2/10，主要问题集中在：
- 路由系统不一致（56处硬编码路由）
- 代码质量下降（38处TODO/FIXME，重复代码）
- 类型安全不足（283处any类型）

这些问题需要在进入新功能开发前解决，以确保代码库的可维护性和扩展性。

## Goals / Non-Goals

### Goals
- **统一路由系统**：所有路由使用统一工具，支持国际化
- **提升代码质量**：清理技术债务，移除重复代码
- **增强类型安全**：消除any类型，完善类型定义
- **统一错误处理**：建立一致的API错误处理模式
- **保持向后兼容**：不改变现有API行为和用户体验

### Non-Goals
- **不改变功能**：本次重构不添加新功能，只改善代码质量
- **不重构架构**：不改变整体架构设计，只优化实现细节
- **不优化性能**：性能优化属于阶段4，不在本次范围
- **不增加测试**：测试覆盖属于阶段3，不在本次范围（但会运行现有测试）

## Decisions

### 决策1: 路由结构选择
**决策**: 优先使用 `src/app/[locale]/` 结构，移除 `src/app/admin` 等非国际化路由

**理由**:
- 项目已采用国际化架构，`[locale]` 结构是标准做法
- 统一结构减少混淆和维护成本
- 符合Next.js App Router最佳实践

**替代方案考虑**:
- 保留两套路由：增加维护成本，不采用
- 完全移除国际化：不符合项目需求，不采用

### 决策2: 路由工具选择
**决策**: 完善并统一使用 `src/lib/routing.ts` 中的 `RoutingUtils` 和 `useRouting` hook

**理由**:
- 已有基础实现，只需完善
- 集中管理路由定义，易于维护
- 支持类型安全和国际化

**替代方案考虑**:
- 使用第三方路由库：增加依赖，不符合项目原则，不采用
- 完全重写路由工具：工作量大，不采用

### 决策3: 错误处理策略
**决策**: 创建统一的错误处理工具函数，不引入新的中间件框架

**理由**:
- Next.js API Routes 已有足够的错误处理能力
- 保持简单，避免过度工程化
- 工具函数易于测试和使用

**替代方案考虑**:
- 使用错误处理中间件：增加复杂度，不采用
- 保持现状：错误处理不一致，不采用

### 决策4: any类型替换策略
**决策**: 渐进式替换，优先处理API路由和公共组件

**理由**:
- 一次性替换风险高，渐进式更安全
- API路由影响面大，优先处理
- 公共组件复用率高，优先处理

**替代方案考虑**:
- 一次性替换所有any：风险高，不采用
- 只替换关键路径：覆盖面不足，不采用

## Risks / Trade-offs

### 风险1: 路由重构可能破坏现有功能
**风险**: 修改路由可能导致页面无法访问或导航错误

**缓解措施**:
- 分阶段实施，每个阶段充分测试
- 保留旧路由的临时重定向（如果需要）
- 充分测试所有导航路径

### 风险2: 类型替换可能引入新的类型错误
**风险**: 替换any类型可能暴露隐藏的类型问题

**缓解措施**:
- 渐进式替换，每次替换后运行类型检查
- 使用类型断言作为临时方案（标记为TODO）
- 充分测试替换后的代码

### 风险3: 错误处理统一可能改变API响应格式
**风险**: 统一错误处理可能影响现有客户端

**缓解措施**:
- 保持现有错误响应格式兼容
- 逐步迁移，不一次性改变所有API
- 更新API文档说明变化

### 权衡1: 代码质量 vs 开发速度
**权衡**: 重构需要时间，可能延迟新功能开发

**决策**: 优先代码质量，因为技术债务会持续影响开发效率

### 权衡2: 彻底清理 vs 渐进改进
**权衡**: 彻底清理效果好但风险高，渐进改进安全但可能不彻底

**决策**: 采用渐进改进，但设定明确的完成标准

## Migration Plan

### 阶段1: 路由系统统一（优先级最高）
1. 识别和分类所有硬编码路由
2. 修复高优先级路由（认证、导航）
3. 修复中低优先级路由
4. 验证所有路由正常工作

### 阶段2: 代码清理（并行进行）
1. 清理TODO/FIXME标记
2. 识别和移除重复代码
3. 统一错误处理

### 阶段3: 类型安全（最后进行）
1. 替换API路由中的any类型
2. 替换组件中的any类型
3. 完善类型定义
4. 启用严格检查

### 回滚计划
- 每个阶段完成后创建git commit
- 如果发现问题，可以回滚到上一阶段
- 保持功能测试通过，确保可以随时回滚

## Open Questions

1. **路由迁移策略**: 是否需要保留旧路由的临时重定向？
   - 建议：不需要，因为主要是内部重构，不涉及外部URL变化

2. **any类型替换优先级**: 是否应该优先替换API路由还是组件？
   - 建议：优先API路由，因为影响面更大

3. **错误处理格式**: 是否需要统一所有API的错误响应格式？
   - 建议：是，但保持向后兼容

4. **测试覆盖**: 重构过程中是否需要增加测试？
   - 建议：运行现有测试，但不强制增加新测试（属于阶段3）

