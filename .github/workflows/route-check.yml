name: ğŸ” è·¯ç”±è§„èŒƒæ£€æŸ¥

on:
  pull_request:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - 'src/**/*.tsx'
      - 'src/**/*.ts'
      - 'src/**/*.jsx'
      - 'src/**/*.js'
  push:
    branches:
      - main
      - develop

jobs:
  route-check:
    name: æ£€æŸ¥ç¡¬ç¼–ç è·¯ç”±
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²,ç”¨äºæ¯”è¾ƒ

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ” è¿è¡Œè·¯ç”±è¯Šæ–­
        id: diagnose
        run: |
          npx tsx scripts/diagnose-routes.ts
          
          # æå–é—®é¢˜æ•°
          TOTAL_ISSUES=$(cat route-diagnosis-report.json | jq '.summary.totalIssues // 0')
          TOTAL_FILES=$(cat route-diagnosis-report.json | jq '.summary.affectedFiles // 0')
          
          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          
          # è¾“å‡ºåˆ°æ—¥å¿—
          echo "å‘ç° $TOTAL_ISSUES ä¸ªè·¯ç”±é—®é¢˜,å½±å“ $TOTAL_FILES ä¸ªæ–‡ä»¶"

      - name: âœ… æ£€æŸ¥ç»“æœ
        if: steps.diagnose.outputs.total_issues != '0'
        run: |
          echo "::error title=è·¯ç”±æ£€æŸ¥å¤±è´¥::å‘ç° ${{ steps.diagnose.outputs.total_issues }} ä¸ªç¡¬ç¼–ç è·¯ç”±"
          
          # è¾“å‡ºè¯¦ç»†æŠ¥å‘Š
          cat route-diagnosis-report.json | jq -r '
            "## è·¯ç”±é—®é¢˜æŠ¥å‘Š\n",
            "- æ€»é—®é¢˜æ•°: \(.summary.totalIssues)",
            "- å½±å“æ–‡ä»¶æ•°: \(.summary.affectedFiles)\n",
            "### é—®é¢˜åˆ†ç±»",
            (.summary.issuesByType | to_entries[] | "- \(.key): \(.value)ä¸ª"),
            "\n### å—å½±å“çš„æ–‡ä»¶",
            (.issues | keys[] | "- `\(.)`")
          '
          
          exit 1

      - name: ğŸ“Š ä¸Šä¼ è¯Šæ–­æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: route-diagnosis-report
          path: route-diagnosis-report.json
          retention-days: 30

      - name: ğŸ’¬ PRè¯„è®º (å¤±è´¥æ—¶)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('route-diagnosis-report.json', 'utf8'));
            
            const issuesByType = Object.entries(report.summary.issuesByType)
              .map(([type, count]) => `- ${type}: ${count}ä¸ª`)
              .join('\n');
            
            const files = Object.keys(report.issues)
              .slice(0, 10)
              .map(file => `- \`${file}\``)
              .join('\n');
            
            const moreFiles = Object.keys(report.issues).length > 10 
              ? `\n... è¿˜æœ‰ ${Object.keys(report.issues).length - 10} ä¸ªæ–‡ä»¶`
              : '';
            
            const body = `## âŒ è·¯ç”±è§„èŒƒæ£€æŸ¥å¤±è´¥
            
            å‘ç° **${report.summary.totalIssues}** ä¸ªç¡¬ç¼–ç è·¯ç”±,å½±å“ **${report.summary.affectedFiles}** ä¸ªæ–‡ä»¶ã€‚
            
            ### ğŸ“Š é—®é¢˜åˆ†ç±»
            ${issuesByType}
            
            ### ğŸ“„ å—å½±å“çš„æ–‡ä»¶ (å‰10ä¸ª)
            ${files}${moreFiles}
            
            ### ğŸ”§ ä¿®å¤æ–¹æ³•
            
            **æ–¹æ¡ˆ1: è‡ªåŠ¨ä¿®å¤ (æ¨è)**
            \`\`\`bash
            npx tsx scripts/fix-routes-auto.ts
            npx tsx scripts/diagnose-routes.ts  # éªŒè¯ä¿®å¤
            \`\`\`
            
            **æ–¹æ¡ˆ2: æ‰‹åŠ¨ä¿®å¤**
            \`\`\`bash
            cat ROUTE_FIX_GUIDE.md  # æŸ¥çœ‹ä¿®å¤æŒ‡å—
            \`\`\`
            
            ### ğŸ“š æ­£ç¡®ç¤ºä¾‹
            
            âŒ é”™è¯¯:
            \`\`\`tsx
            <Link href="/login">ç™»å½•</Link>
            router.push("/profile")
            \`\`\`
            
            âœ… æ­£ç¡®:
            \`\`\`tsx
            import { useRouting } from '@/lib/routing';
            
            const { route, routes } = useRouting();
            <Link href={route(routes.AUTH.LOGIN)}>ç™»å½•</Link>
            router.push(route("/profile"))
            \`\`\`
            
            ä¿®å¤åè¯·é‡æ–°æ¨é€ä»£ç ,CIä¼šè‡ªåŠ¨é‡æ–°æ£€æŸ¥ã€‚`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: âœ… æˆåŠŸæ¶ˆæ¯
        if: success() && steps.diagnose.outputs.total_issues == '0'
        run: |
          echo "::notice title=è·¯ç”±æ£€æŸ¥é€šè¿‡::âœ… æœªå‘ç°ç¡¬ç¼–ç è·¯ç”±,æ‰€æœ‰è·¯ç”±è§„èŒƒç¬¦åˆè¦æ±‚"
