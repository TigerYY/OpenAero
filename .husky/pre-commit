#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# è·å–é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

echo "ğŸ” è¿è¡Œé¢„æäº¤æ£€æŸ¥..."
echo ""

# æ£€æŸ¥æ˜¯å¦æœ‰è·¯ç”±ç›¸å…³æ–‡ä»¶è¢«ä¿®æ”¹
ROUTE_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(tsx?|jsx?)$' | grep -E 'src/(app|components|lib)' || true)

if [ -n "$ROUTE_FILES" ]; then
  echo "ğŸ“‹ æ£€æµ‹åˆ°è·¯ç”±ç›¸å…³æ–‡ä»¶å˜æ›´,è¿è¡Œè·¯ç”±æ£€æŸ¥..."
  echo ""
  
  # è¿è¡Œè·¯ç”±è¯Šæ–­
  if ! npx tsx "$PROJECT_ROOT/scripts/diagnose-routes.ts" > /dev/null 2>&1; then
    echo "âŒ è·¯ç”±è¯Šæ–­è„šæœ¬æ‰§è¡Œå¤±è´¥"
    exit 1
  fi
  
  # æ£€æŸ¥é—®é¢˜æ•°
  TOTAL_ISSUES=$(cat "$PROJECT_ROOT/route-diagnosis-report.json" | jq '.summary.totalIssues // 0')
  
  if [ "$TOTAL_ISSUES" -gt 0 ]; then
    echo "âŒ å‘ç° $TOTAL_ISSUES ä¸ªè·¯ç”±é—®é¢˜"
    echo ""
    echo "è¯·å…ˆä¿®å¤è·¯ç”±é—®é¢˜åå†æäº¤:"
    echo "  npx tsx scripts/fix-routes-auto.ts"
    echo ""
    echo "æˆ–è·³è¿‡æ£€æŸ¥å¼ºåˆ¶æäº¤:"
    echo "  git commit --no-verify"
    echo ""
    exit 1
  fi
  
  echo "âœ… è·¯ç”±æ£€æŸ¥é€šè¿‡"
  echo ""
fi

# è¿è¡Œ lint-staged
npx lint-staged
