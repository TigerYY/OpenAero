# âœ… Supabase Auth è®¤è¯ç³»ç»Ÿå®æ–½å®Œæˆ

## ğŸ“‹ å®æ–½æ€»ç»“

å·²æˆåŠŸå°† OpenAero é¡¹ç›®è¿ç§»åˆ°åŸºäº Supabase Auth çš„è®¤è¯ç³»ç»Ÿï¼Œå®Œå…¨ç§»é™¤äº†å¯¹ Prisma æ•°æ®åº“çš„ä¾èµ–ã€‚

## ğŸ¯ å·²å®Œæˆçš„ä»»åŠ¡

### 1. âœ… æ•°æ®åº“è®¾è®¡å’Œè¿ç§»

**å·²åˆ›å»ºçš„è¡¨:**
- `user_profiles` - ç”¨æˆ·æ‰©å±•èµ„æ–™è¡¨
- `creator_profiles` - åˆ›ä½œè€…è®¤è¯èµ„æ–™è¡¨
- `user_addresses` - ç”¨æˆ·åœ°å€ç®¡ç†è¡¨
- `user_sessions` - ç”¨æˆ·ä¼šè¯æ—¥å¿—è¡¨
- `audit_logs` - ç³»ç»Ÿå®¡è®¡æ—¥å¿—è¡¨

**æ–‡ä»¶ä½ç½®:**
- SQL è¿ç§»è„šæœ¬: `supabase/migrations/001_create_user_tables.sql`
- è¿ç§»æ‰§è¡Œè„šæœ¬: `scripts/run-supabase-migration.js`

**æ•°æ®åº“ç‰¹æ€§:**
- âœ… Row Level Security (RLS) å·²å¯ç”¨
- âœ… è‡ªåŠ¨è§¦å‘å™¨ (æ–°ç”¨æˆ·è‡ªåŠ¨åˆ›å»º profile)
- âœ… æ›´æ–°æ—¶é—´è‡ªåŠ¨æ›´æ–°
- âœ… å®Œæ•´çš„ç´¢å¼•ä¼˜åŒ–

### 2. âœ… è®¤è¯æœåŠ¡å®ç°

**æ ¸å¿ƒæ–‡ä»¶:**
- `src/lib/auth/supabase-client.ts` - Supabase å®¢æˆ·ç«¯é…ç½®
- `src/lib/auth/auth-service.ts` - è®¤è¯æœåŠ¡ç±»

**åŠŸèƒ½:**
- âœ… ç”¨æˆ·æ³¨å†Œ (ä»…é‚®ç®±+å¯†ç )
- âœ… ç”¨æˆ·ç™»å½•
- âœ… ç”¨æˆ·ç™»å‡º
- âœ… é‚®ç®±éªŒè¯
- âœ… å¯†ç é‡ç½®
- âœ… ç”¨æˆ·èµ„æ–™ç®¡ç†
- âœ… æƒé™æ£€æŸ¥
- âœ… è§’è‰²ç®¡ç†
- âœ… å®¡è®¡æ—¥å¿—

### 3. âœ… API è·¯ç”±

**å·²å®ç°çš„ API:**
```
POST   /api/auth/register        - ç”¨æˆ·æ³¨å†Œ
POST   /api/auth/login           - ç”¨æˆ·ç™»å½•
POST   /api/auth/logout          - ç”¨æˆ·ç™»å‡º
POST   /api/auth/forgot-password - å¿˜è®°å¯†ç 
POST   /api/auth/reset-password  - é‡ç½®å¯†ç 
GET    /api/auth/callback        - Auth å›è°ƒå¤„ç†
GET    /api/users/me             - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
PATCH  /api/users/me             - æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
```

### 4. âœ… é‚®ä»¶ç³»ç»Ÿ

**é‚®ä»¶æ¨¡æ¿:**
- `src/lib/email/email-templates.ts` - å®Œæ•´çš„é‚®ä»¶æ¨¡æ¿

**æ¨¡æ¿ç±»å‹:**
- âœ… æ¬¢è¿é‚®ä»¶
- âœ… é‚®ç®±éªŒè¯
- âœ… å¯†ç é‡ç½®
- âœ… åˆ›ä½œè€…ç”³è¯·å®¡æ ¸é€šçŸ¥

**SMTP é…ç½®:**
- æä¾›å•†: è…¾è®¯ä¼ä¸šé‚®ç®±
- é…ç½®æ–‡æ¡£: `SUPABASE_EMAIL_SETUP.md`

## ğŸ”§ é…ç½®æ­¥éª¤

### æ­¥éª¤ 1: ç¯å¢ƒå˜é‡é…ç½®

`.env.local` å·²é…ç½®:
```env
# Supabase é…ç½®
NEXT_PUBLIC_SUPABASE_URL=https://cardynuoazvaytvinxvm.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# åº”ç”¨é…ç½®
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### æ­¥éª¤ 2: æ•°æ®åº“è¿ç§»

**çŠ¶æ€:** âœ… å·²å®Œæˆ

æ‰§è¡Œæ–¹å¼:
- åœ¨ Supabase Dashboard SQL Editor ä¸­æ‰§è¡Œ
- æ–‡ä»¶: `supabase/migrations/001_create_user_tables.sql`

### æ­¥éª¤ 3: SMTP é…ç½®

**å¾…å®Œæˆ:** âš ï¸ éœ€è¦åœ¨ Supabase Dashboard ä¸­é…ç½®

è¯·å‚è€ƒæ–‡æ¡£: `SUPABASE_EMAIL_SETUP.md`

**é…ç½®ä¿¡æ¯:**
```
SMTP Host: smtp.exmail.qq.com
SMTP Port: 465
SMTP User: support@openaero.cn
SMTP Pass: zdM469e7q3ZU2gy7
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ supabase-client.ts      # Supabase å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ auth-service.ts         # è®¤è¯æœåŠ¡
â”‚   â””â”€â”€ email/
â”‚       â””â”€â”€ email-templates.ts      # é‚®ä»¶æ¨¡æ¿
â”œâ”€â”€ app/
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ auth/
â”‚       â”‚   â”œâ”€â”€ register/route.ts   # æ³¨å†Œ API
â”‚       â”‚   â”œâ”€â”€ login/route.ts      # ç™»å½• API
â”‚       â”‚   â”œâ”€â”€ logout/route.ts     # ç™»å‡º API
â”‚       â”‚   â”œâ”€â”€ forgot-password/route.ts
â”‚       â”‚   â”œâ”€â”€ reset-password/route.ts
â”‚       â”‚   â””â”€â”€ callback/route.ts   # Auth å›è°ƒ
â”‚       â””â”€â”€ users/
â”‚           â””â”€â”€ me/route.ts         # ç”¨æˆ·ä¿¡æ¯ API

supabase/
â””â”€â”€ migrations/
    â””â”€â”€ 001_create_user_tables.sql  # æ•°æ®åº“è¿ç§»

scripts/
â”œâ”€â”€ run-supabase-migration.js       # è¿ç§»æ‰§è¡Œè„šæœ¬
â””â”€â”€ setup-supabase-db.sh            # æ•°æ®åº“è®¾ç½®è„šæœ¬
```

## ğŸ” å®‰å…¨ç‰¹æ€§

1. **Row Level Security (RLS)**
   - ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
   - ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰æ•°æ®
   - ç»†ç²’åº¦çš„æƒé™æ§åˆ¶

2. **å®¡è®¡æ—¥å¿—**
   - æ‰€æœ‰é‡è¦æ“ä½œéƒ½è¢«è®°å½•
   - åŒ…å« IPã€User Agent ç­‰ä¿¡æ¯
   - æ”¯æŒå¤±è´¥æ“ä½œè¿½è¸ª

3. **å¯†ç å®‰å…¨**
   - æœ€å°‘ 8 ä¸ªå­—ç¬¦
   - å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯å’Œæ•°å­—
   - Supabase è‡ªåŠ¨åŠ å¯†å­˜å‚¨

4. **ä¼šè¯ç®¡ç†**
   - è‡ªåŠ¨åˆ·æ–° token
   - ä¼šè¯è¿‡æœŸç®¡ç†
   - æ”¯æŒå¤šè®¾å¤‡ç™»å½•è¿½è¸ª

## ğŸ­ ç”¨æˆ·è§’è‰²ç³»ç»Ÿ

å®šä¹‰äº† 6 ä¸ªè§’è‰²å±‚çº§:

1. **USER** - æ™®é€šç”¨æˆ· (é»˜è®¤)
   - æµè§ˆå’Œè´­ä¹°æ–¹æ¡ˆ
   - ç®¡ç†ä¸ªäººèµ„æ–™

2. **CREATOR** - åˆ›ä½œè€…
   - USER çš„æ‰€æœ‰æƒé™
   - ä¸Šä¼ å’Œé”€å”®æ–¹æ¡ˆ
   - æŸ¥çœ‹æ”¶ç›Šæ•°æ®

3. **REVIEWER** - å®¡æ ¸å‘˜
   - å®¡æ ¸æ–¹æ¡ˆ
   - æ‰¹å‡†/æ‹’ç»æäº¤

4. **FACTORY_MANAGER** - å·¥å‚ç®¡ç†å‘˜
   - ç®¡ç†å·¥å‚ä¿¡æ¯
   - å¤„ç†è¯•äº§è®¢å•

5. **ADMIN** - ç®¡ç†å‘˜
   - ç”¨æˆ·ç®¡ç†
   - å†…å®¹ç®¡ç†
   - ç³»ç»Ÿé…ç½®

6. **SUPER_ADMIN** - è¶…çº§ç®¡ç†å‘˜
   - å®Œæ•´ç³»ç»Ÿæƒé™
   - è§’è‰²åˆ†é…
   - æ•æ„Ÿæ“ä½œ

## ğŸ“Š æ•°æ®æµç¨‹

### ç”¨æˆ·æ³¨å†Œæµç¨‹:
```
1. ç”¨æˆ·å¡«å†™æ³¨å†Œè¡¨å•
   â†“
2. POST /api/auth/register
   â†“
3. Supabase Auth åˆ›å»ºç”¨æˆ· (auth.users)
   â†“
4. æ•°æ®åº“è§¦å‘å™¨è‡ªåŠ¨åˆ›å»º user_profiles
   â†“
5. Supabase å‘é€éªŒè¯é‚®ä»¶
   â†“
6. ç”¨æˆ·ç‚¹å‡»éªŒè¯é“¾æ¥
   â†“
7. GET /api/auth/callback?code=xxx
   â†“
8. ç”¨æˆ·é‚®ç®±éªŒè¯å®Œæˆ
```

### ç”¨æˆ·ç™»å½•æµç¨‹:
```
1. ç”¨æˆ·è¾“å…¥é‚®ç®±å¯†ç 
   â†“
2. POST /api/auth/login
   â†“
3. Supabase Auth éªŒè¯å‡­æ®
   â†“
4. è¿”å› session (access_token + refresh_token)
   â†“
5. æ›´æ–° last_login_at
   â†“
6. è®°å½•å®¡è®¡æ—¥å¿—
   â†“
7. è¿”å›ç”¨æˆ·ä¿¡æ¯
```

### å¯†ç é‡ç½®æµç¨‹:
```
1. ç”¨æˆ·è¯·æ±‚é‡ç½®å¯†ç 
   â†“
2. POST /api/auth/forgot-password
   â†“
3. Supabase å‘é€é‡ç½®é‚®ä»¶
   â†“
4. ç”¨æˆ·ç‚¹å‡»é‡ç½®é“¾æ¥
   â†“
5. GET /api/auth/callback?code=xxx&type=recovery
   â†“
6. ç”¨æˆ·è®¾ç½®æ–°å¯†ç 
   â†“
7. POST /api/auth/reset-password
   â†“
8. å¯†ç æ›´æ–°å®Œæˆ
```

## ğŸ§ª æµ‹è¯•æ¸…å•

### åŠŸèƒ½æµ‹è¯•:
- [ ] ç”¨æˆ·æ³¨å†Œ
- [ ] é‚®ç®±éªŒè¯
- [ ] ç”¨æˆ·ç™»å½•
- [ ] å¯†ç é‡ç½®
- [ ] ç”¨æˆ·ç™»å‡º
- [ ] æ›´æ–°ç”¨æˆ·èµ„æ–™
- [ ] è§’è‰²æƒé™æ£€æŸ¥

### å®‰å…¨æµ‹è¯•:
- [ ] SQL æ³¨å…¥é˜²æŠ¤
- [ ] XSS é˜²æŠ¤
- [ ] CSRF é˜²æŠ¤
- [ ] é€Ÿç‡é™åˆ¶
- [ ] RLS ç­–ç•¥éªŒè¯

### é‚®ä»¶æµ‹è¯•:
- [ ] æ³¨å†ŒéªŒè¯é‚®ä»¶
- [ ] å¯†ç é‡ç½®é‚®ä»¶
- [ ] æ¬¢è¿é‚®ä»¶
- [ ] é‚®ä»¶æ¨¡æ¿æ¸²æŸ“

## ğŸš€ åç»­æ­¥éª¤

### å¿…é¡»å®Œæˆ:
1. **é…ç½® Supabase SMTP**
   - å‚è€ƒ `SUPABASE_EMAIL_SETUP.md`
   - åœ¨ Dashboard ä¸­é…ç½®è…¾è®¯ä¼ä¸šé‚®ç®±

2. **åˆ›å»ºå‰ç«¯é¡µé¢**
   - æ³¨å†Œé¡µé¢
   - ç™»å½•é¡µé¢
   - å¯†ç é‡ç½®é¡µé¢
   - ç”¨æˆ·ä¸­å¿ƒ

3. **æµ‹è¯•å®Œæ•´æµç¨‹**
   - æ³¨å†Œ â†’ éªŒè¯ â†’ ç™»å½•
   - å¿˜è®°å¯†ç  â†’ é‡ç½® â†’ ç™»å½•
   - æ›´æ–°èµ„æ–™

### å¯é€‰ä¼˜åŒ–:
1. **å¤šè¯­è¨€æ”¯æŒ**
   - é‚®ä»¶æ¨¡æ¿å›½é™…åŒ–
   - é”™è¯¯ä¿¡æ¯æœ¬åœ°åŒ–

2. **ç¤¾äº¤ç™»å½•** (åæœŸ)
   - Google OAuth
   - GitHub OAuth
   - å¾®ä¿¡ç™»å½•

3. **åŒå› ç´ è®¤è¯** (åæœŸ)
   - TOTP (Google Authenticator)
   - SMSéªŒè¯ç 

4. **ä¼šè¯ç®¡ç†å¢å¼º**
   - æŸ¥çœ‹æ´»è·ƒè®¾å¤‡
   - è¿œç¨‹ç™»å‡º
   - å¯ç–‘æ´»åŠ¨è­¦æŠ¥

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [Supabase Auth æ–‡æ¡£](https://supabase.com/docs/guides/auth)
- [SMTP é…ç½®æŒ‡å—](./SUPABASE_EMAIL_SETUP.md)
- [æ•°æ®åº“è¿ç§»è„šæœ¬](./supabase/migrations/001_create_user_tables.sql)

## ğŸ†˜ æ•…éšœæ’æŸ¥

### é—®é¢˜: é‚®ä»¶æœªå‘é€
**è§£å†³:** 
1. æ£€æŸ¥ Supabase SMTP é…ç½®
2. æŸ¥çœ‹ Supabase Dashboard Logs
3. éªŒè¯ SMTP å‡­æ®

### é—®é¢˜: RLS æƒé™é”™è¯¯
**è§£å†³:**
1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
2. éªŒè¯ RLS ç­–ç•¥
3. ä½¿ç”¨ Service Role Key (ä»…æœåŠ¡å™¨ç«¯)

### é—®é¢˜: Token è¿‡æœŸ
**è§£å†³:**
1. å¯ç”¨è‡ªåŠ¨åˆ·æ–°: `autoRefreshToken: true`
2. æ‰‹åŠ¨åˆ·æ–°: `supabase.auth.refreshSession()`

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹:
- Supabaseæ–‡æ¡£: https://supabase.com/docs
- é¡¹ç›® Issues: [GitHub Issues]
- æŠ€æœ¯æ”¯æŒ: contact@openaero.cn

---

**æœ€åæ›´æ–°:** 2025-11-11
**ç‰ˆæœ¬:** 1.0.0
**çŠ¶æ€:** å¼€å‘ä¸­ ğŸš§
