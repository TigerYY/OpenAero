<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿«é€Ÿè®¤è¯æ£€æŸ¥ - OpenAero</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      background: white; 
      border-radius: 12px; 
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 { 
      color: #667eea; 
      margin-bottom: 10px; 
      font-size: 28px;
    }
    .subtitle { 
      color: #666; 
      margin-bottom: 30px; 
      font-size: 14px;
    }
    .check-item { 
      padding: 15px; 
      margin: 10px 0; 
      border-radius: 8px; 
      border-left: 4px solid #ddd;
      background: #f9f9f9;
    }
    .check-item.pending { border-left-color: #ffa500; background: #fff9f0; }
    .check-item.success { border-left-color: #10b981; background: #f0fdf4; }
    .check-item.error { border-left-color: #ef4444; background: #fef2f2; }
    .check-item h3 { 
      font-size: 16px; 
      margin-bottom: 8px; 
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .check-item p { font-size: 14px; color: #666; line-height: 1.6; }
    .icon { font-size: 20px; }
    .code { 
      background: #1e293b; 
      color: #e2e8f0; 
      padding: 15px; 
      border-radius: 6px; 
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    button { 
      background: #667eea; 
      color: white; 
      border: none; 
      padding: 12px 24px; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 16px;
      margin: 10px 10px 10px 0;
      transition: all 0.3s;
    }
    button:hover { background: #5568d3; transform: translateY(-2px); }
    button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .summary {
      background: #f0f9ff;
      border: 2px solid #0ea5e9;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .summary h3 { color: #0369a1; margin-bottom: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” OpenAero å¿«é€Ÿè®¤è¯æ£€æŸ¥</h1>
    <p class="subtitle">ç³»ç»Ÿæ€§æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€å’Œ profile æ•°æ®</p>

    <button onclick="runAllChecks()" id="checkBtn">å¼€å§‹æ£€æŸ¥</button>
    <button onclick="location.reload()">é‡ç½®</button>

    <div id="results"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://cardynuoazvaytvinxvm.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhcmR5bnVvYXp2YXl0dmlueHZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1ODk0MTUsImV4cCI6MjA3NjE2NTQxNX0.s7gVeKupd0Rny4JeQr3SL4BTuv9uE6jdDz_rt-X9UaI';

    const results = document.getElementById('results');

    function addCheckItem(title, status, message, details = '') {
      const icons = {
        pending: 'â³',
        success: 'âœ…',
        error: 'âŒ'
      };
      
      const item = document.createElement('div');
      item.className = `check-item ${status}`;
      item.innerHTML = `
        <h3><span class="icon">${icons[status]}</span>${title}</h3>
        <p>${message}</p>
        ${details ? `<div class="code">${details}</div>` : ''}
      `;
      results.appendChild(item);
    }

    async function runAllChecks() {
      results.innerHTML = '';
      document.getElementById('checkBtn').disabled = true;

      // æ£€æŸ¥ 1: Supabase é…ç½®
      addCheckItem('æ£€æŸ¥ Supabase é…ç½®', 'pending', 'æ­£åœ¨éªŒè¯...');
      
      if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
        addCheckItem(
          'æ£€æŸ¥ Supabase é…ç½®', 
          'error', 
          'è¯·å…ˆé…ç½® Supabase URL å’Œ ANON KEY',
          'åœ¨æ­¤æ–‡ä»¶ä¸­ä¿®æ”¹ SUPABASE_URL å’Œ SUPABASE_ANON_KEY å¸¸é‡'
        );
        document.getElementById('checkBtn').disabled = false;
        return;
      }

      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      results.innerHTML = '';
      
      addCheckItem('æ£€æŸ¥ Supabase é…ç½®', 'success', 'é…ç½®æ­£ç¡®');

      // æ£€æŸ¥ 2: è®¤è¯çŠ¶æ€
      addCheckItem('æ£€æŸ¥è®¤è¯çŠ¶æ€', 'pending', 'æ­£åœ¨æ£€æŸ¥...');
      
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      
      if (sessionError) {
        addCheckItem('æ£€æŸ¥è®¤è¯çŠ¶æ€', 'error', `è·å–ä¼šè¯å¤±è´¥: ${sessionError.message}`);
        document.getElementById('checkBtn').disabled = false;
        return;
      }

      if (!session) {
        addCheckItem('æ£€æŸ¥è®¤è¯çŠ¶æ€', 'error', 'æœªç™»å½•', 'è¯·å…ˆç™»å½•åå†è¿è¡Œæ­¤æ£€æŸ¥');
        document.getElementById('checkBtn').disabled = false;
        return;
      }

      addCheckItem(
        'æ£€æŸ¥è®¤è¯çŠ¶æ€', 
        'success', 
        `å·²ç™»å½•: ${session.user.email}`,
        `ç”¨æˆ· ID: ${session.user.id}\nåˆ›å»ºæ—¶é—´: ${new Date(session.user.created_at).toLocaleString('zh-CN')}`
      );

      // æ£€æŸ¥ 3: User Profile å­˜åœ¨æ€§
      addCheckItem('æ£€æŸ¥ User Profile', 'pending', 'æ­£åœ¨æŸ¥è¯¢...');
      
      const { data: profile, error: profileError } = await supabase
        .from('user_profiles')
        .select('*')
        .eq('user_id', session.user.id)
        .single();

      if (profileError) {
        if (profileError.code === 'PGRST116') {
          addCheckItem(
            'æ£€æŸ¥ User Profile', 
            'error', 
            'âŒ Profile ä¸å­˜åœ¨ï¼è¿™æ˜¯ä¸»è¦é—®é¢˜ï¼',
            `é”™è¯¯ä»£ç : PGRST116 (æœªæ‰¾åˆ°è®°å½•)\n\nè¿™æ„å‘³ç€ auth.users ä¸­æœ‰ä½ çš„è´¦å·ï¼Œä½† user_profiles è¡¨ä¸­æ²¡æœ‰å¯¹åº”è®°å½•ã€‚\n\nå¯èƒ½åŸå› ï¼š\n1. æ•°æ®åº“è§¦å‘å™¨æœªæ­£ç¡®æ‰§è¡Œ\n2. æ³¨å†Œæ—¶çš„ profile åˆ›å»ºå¤±è´¥\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. æ‰§è¡Œä¿®å¤è„šæœ¬: ./scripts/diagnose-and-fix.sh\n2. æˆ–æ‰‹åŠ¨æ‰§è¡Œ: supabase db execute --file scripts/fix-missing-profiles.sql`
          );
        } else {
          addCheckItem(
            'æ£€æŸ¥ User Profile', 
            'error', 
            `æŸ¥è¯¢å¤±è´¥: ${profileError.message}`,
            JSON.stringify(profileError, null, 2)
          );
        }
      } else if (profile) {
        addCheckItem(
          'æ£€æŸ¥ User Profile', 
          'success', 
          'Profile å­˜åœ¨',
          `æ˜¾ç¤ºåç§°: ${profile.display_name || '(æœªè®¾ç½®)'}\nè§’è‰²: ${profile.role}\nçŠ¶æ€: ${profile.status}\nåˆ›å»ºæ—¶é—´: ${new Date(profile.created_at).toLocaleString('zh-CN')}`
        );

        // æ£€æŸ¥ 4: å­—æ®µå®Œæ•´æ€§
        addCheckItem('æ£€æŸ¥ Profile å­—æ®µ', 'pending', 'æ­£åœ¨éªŒè¯...');
        
        const requiredFields = ['user_id', 'role', 'status', 'created_at', 'updated_at'];
        const missingFields = requiredFields.filter(field => !profile[field]);
        
        if (missingFields.length > 0) {
          addCheckItem(
            'æ£€æŸ¥ Profile å­—æ®µ', 
            'error', 
            `ç¼ºå°‘å¿…å¡«å­—æ®µ: ${missingFields.join(', ')}`
          );
        } else {
          addCheckItem('æ£€æŸ¥ Profile å­—æ®µ', 'success', 'æ‰€æœ‰å¿…å¡«å­—æ®µå®Œæ•´');
        }

        // æ£€æŸ¥ 5: å­—æ®µæ˜ å°„æ­£ç¡®æ€§
        addCheckItem('æ£€æŸ¥å­—æ®µæ˜ å°„', 'pending', 'æ­£åœ¨éªŒè¯...');
        
        const oldFieldsFound = [];
        if (profile.fullName !== undefined) oldFieldsFound.push('fullName');
        if (profile.username !== undefined) oldFieldsFound.push('username');
        if (profile.phoneNumber !== undefined) oldFieldsFound.push('phoneNumber');
        
        if (oldFieldsFound.length > 0) {
          addCheckItem(
            'æ£€æŸ¥å­—æ®µæ˜ å°„', 
            'error', 
            `å‘ç°æ—§å­—æ®µ: ${oldFieldsFound.join(', ')}`,
            'æ•°æ®åº“ä¸­ä¸åº”è¯¥æœ‰è¿™äº›å­—æ®µï¼Œè¯·æ£€æŸ¥æ•°æ®åº“è¿ç§»'
          );
        } else {
          addCheckItem('æ£€æŸ¥å­—æ®µæ˜ å°„', 'success', 'æ²¡æœ‰å‘ç°æ—§å­—æ®µå¼•ç”¨');
        }
      }

      // æ£€æŸ¥ 6: RLS ç­–ç•¥
      addCheckItem('æ£€æŸ¥ RLS ç­–ç•¥', 'pending', 'æ­£åœ¨æµ‹è¯•...');
      
      const { count, error: countError } = await supabase
        .from('user_profiles')
        .select('*', { count: 'exact', head: true });

      if (countError) {
        addCheckItem(
          'æ£€æŸ¥ RLS ç­–ç•¥', 
          'error', 
          `RLS å¯èƒ½é˜»æ­¢è®¿é—®: ${countError.message}`,
          'è¯·è¿è¡Œ scripts/verify-rls-policies.sql æ£€æŸ¥ç­–ç•¥'
        );
      } else {
        addCheckItem(
          'æ£€æŸ¥ RLS ç­–ç•¥', 
          'success', 
          `RLS ç­–ç•¥æ­£å¸¸ï¼Œå¯è®¿é—® ${count} æ¡è®°å½•`
        );
      }

      // æœ€ç»ˆæ€»ç»“
      const summary = document.createElement('div');
      summary.className = 'summary';
      
      if (!profile) {
        summary.innerHTML = `
          <h3>ğŸ”´ æ£€æŸ¥å®Œæˆ - å‘ç°é—®é¢˜</h3>
          <p><strong>ä¸»è¦é—®é¢˜ï¼š</strong>User Profile ä¸å­˜åœ¨</p>
          <p><strong>ç«‹å³æ‰§è¡Œï¼š</strong></p>
          <div class="code">cd /Users/yangyang/Documents/YYCode/OpenAero/openaero.web
./scripts/diagnose-and-fix.sh</div>
          <p>æˆ–åœ¨ Supabase Dashboard SQL Editor ä¸­æ‰§è¡Œ scripts/fix-missing-profiles.sql</p>
        `;
      } else {
        summary.innerHTML = `
          <h3>ğŸŸ¢ æ£€æŸ¥å®Œæˆ - åŸºæœ¬æ­£å¸¸</h3>
          <p><strong>ä¸‹ä¸€æ­¥ï¼š</strong>æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶è®¿é—® /zh-CN/profile æµ‹è¯•</p>
        `;
      }
      
      results.appendChild(summary);
      document.getElementById('checkBtn').disabled = false;
    }
  </script>
</body>
</html>
