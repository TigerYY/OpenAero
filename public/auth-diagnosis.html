<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¤è¯ç³»ç»Ÿè¯Šæ–­å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 20px; }
        .section { 
            background: white; 
            border-radius: 8px; 
            padding: 20px; 
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 { 
            color: #0066cc; 
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e5e5;
        }
        button { 
            background: #0066cc; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 6px; 
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover { background: #0052a3; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #5a6268; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        pre { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 4px; 
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
        }
        .status { 
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        input { 
            width: 100%; 
            padding: 10px; 
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” OpenAero è®¤è¯ç³»ç»Ÿè¯Šæ–­å·¥å…·</h1>
        
        <!-- ç¯å¢ƒæ£€æŸ¥ -->
        <div class="section">
            <h2>1. ç¯å¢ƒé…ç½®æ£€æŸ¥</h2>
            <button onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒ</button>
            <pre id="env-output">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ£€æŸ¥...</pre>
        </div>

        <!-- Supabaseè¿æ¥æµ‹è¯• -->
        <div class="section">
            <h2>2. Supabaseè¿æ¥æµ‹è¯•</h2>
            <button onclick="testSupabaseConnection()">æµ‹è¯•è¿æ¥</button>
            <pre id="connection-output">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</pre>
        </div>

        <!-- æ•°æ®åº“è¡¨æ£€æŸ¥ -->
        <div class="section">
            <h2>3. æ•°æ®åº“è¡¨æ£€æŸ¥</h2>
            <button onclick="checkTables()">æ£€æŸ¥è¡¨ç»“æ„</button>
            <button class="secondary" onclick="checkRLS()">æ£€æŸ¥RLSç­–ç•¥</button>
            <pre id="tables-output">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ£€æŸ¥...</pre>
        </div>

        <!-- ç™»å½•æµ‹è¯• -->
        <div class="section">
            <h2>4. ç™»å½•åŠŸèƒ½æµ‹è¯•</h2>
            <div class="grid">
                <input type="email" id="test-email" placeholder="æµ‹è¯•é‚®ç®±">
                <input type="password" id="test-password" placeholder="æµ‹è¯•å¯†ç ">
            </div>
            <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
            <button class="secondary" onclick="testRegister()">æµ‹è¯•æ³¨å†Œ</button>
            <button class="danger" onclick="testLogout()">æµ‹è¯•ç™»å‡º</button>
            <pre id="login-output">è¾“å…¥æµ‹è¯•è´¦å·åç‚¹å‡»æŒ‰é’®...</pre>
        </div>

        <!-- å½“å‰ä¼šè¯æ£€æŸ¥ -->
        <div class="section">
            <h2>5. å½“å‰ä¼šè¯çŠ¶æ€</h2>
            <button onclick="checkSession()">æ£€æŸ¥ä¼šè¯</button>
            <button class="secondary" onclick="checkProfile()">æ£€æŸ¥Profile</button>
            <button class="secondary" onclick="createProfile()">åˆ›å»ºProfile</button>
            <pre id="session-output">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ£€æŸ¥...</pre>
        </div>

        <!-- è§¦å‘å™¨æ£€æŸ¥ -->
        <div class="section">
            <h2>6. æ•°æ®åº“è§¦å‘å™¨æµ‹è¯•</h2>
            <button onclick="checkTriggers()">æ£€æŸ¥è§¦å‘å™¨</button>
            <button class="secondary" onclick="testTrigger()">æµ‹è¯•è§¦å‘å™¨</button>
            <pre id="trigger-output">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ£€æŸ¥...</pre>
        </div>

        <!-- å®Œæ•´è¯Šæ–­ -->
        <div class="section">
            <h2>7. å®Œæ•´ç³»ç»Ÿè¯Šæ–­</h2>
            <button onclick="runFullDiagnosis()" style="background: #28a745;">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <pre id="full-output">ç‚¹å‡»æŒ‰é’®å¼€å§‹å®Œæ•´è¯Šæ–­...</pre>
        </div>
    </div>

    <script>
        // Supabaseé…ç½®
        const SUPABASE_URL = 'https://cardynuoazvaytvinxvm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNhcmR5bnVvYXp2YXl0dmlueHZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1ODk0MTUsImV4cCI6MjA3NjE2NTQxNX0.s7gVeKupd0Rny4JeQr3SL4BTuv9uE6jdDz_rt-X9UaI';

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(elementId, message, type = 'info') {
            const el = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            el.textContent += `[${timestamp}] ${icon} ${message}\n`;
            el.scrollTop = el.scrollHeight;
        }

        function clear(elementId) {
            document.getElementById(elementId).textContent = '';
        }

        // 1. ç¯å¢ƒæ£€æŸ¥
        async function checkEnvironment() {
            clear('env-output');
            log('env-output', 'å¼€å§‹æ£€æŸ¥ç¯å¢ƒé…ç½®...');
            
            log('env-output', `Supabase URL: ${SUPABASE_URL}`, 'success');
            log('env-output', `Anon Key: ${SUPABASE_ANON_KEY.substring(0, 20)}...`, 'success');
            
            // æ£€æŸ¥localStorage
            const keys = Object.keys(localStorage).filter(k => k.includes('supabase') || k.includes('openaero'));
            log('env-output', `LocalStorage keys: ${keys.length} ä¸ª`, keys.length > 0 ? 'success' : 'warning');
            keys.forEach(k => log('env-output', `  - ${k}`));
        }

        // 2. Supabaseè¿æ¥æµ‹è¯•
        async function testSupabaseConnection() {
            clear('connection-output');
            log('connection-output', 'æµ‹è¯•Supabaseè¿æ¥...');
            
            try {
                const { data, error } = await supabase.auth.getSession();
                if (error) throw error;
                
                log('connection-output', 'Supabaseè¿æ¥æˆåŠŸï¼', 'success');
                log('connection-output', `ä¼šè¯çŠ¶æ€: ${data.session ? 'å·²ç™»å½•' : 'æœªç™»å½•'}`, data.session ? 'success' : 'warning');
            } catch (error) {
                log('connection-output', `è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 3. æ£€æŸ¥è¡¨
        async function checkTables() {
            clear('tables-output');
            log('tables-output', 'æ£€æŸ¥æ•°æ®åº“è¡¨...');
            
            const tables = ['user_profiles', 'creator_profiles'];
            
            for (const table of tables) {
                try {
                    const { count, error } = await supabase
                        .from(table)
                        .select('*', { count: 'exact', head: true });
                    
                    if (error) {
                        log('tables-output', `${table}: âŒ ${error.message}`, 'error');
                    } else {
                        log('tables-output', `${table}: âœ… å­˜åœ¨ (${count} æ¡è®°å½•)`, 'success');
                    }
                } catch (error) {
                    log('tables-output', `${table}: âŒ ${error.message}`, 'error');
                }
            }
        }

        // æ£€æŸ¥RLS
        async function checkRLS() {
            log('tables-output', '\næ£€æŸ¥RLSç­–ç•¥...');
            
            try {
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    log('tables-output', `RLSæ£€æŸ¥: ${error.message}`, 'warning');
                } else {
                    log('tables-output', 'RLSç­–ç•¥æ­£å¸¸', 'success');
                }
            } catch (error) {
                log('tables-output', `RLSé”™è¯¯: ${error.message}`, 'error');
            }
        }

        // 4. æµ‹è¯•ç™»å½•
        async function testLogin() {
            clear('login-output');
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            if (!email || !password) {
                log('login-output', 'è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }
            
            log('login-output', `å°è¯•ç™»å½•: ${email}`);
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                log('login-output', 'ç™»å½•æˆåŠŸï¼', 'success');
                log('login-output', `ç”¨æˆ·ID: ${data.user.id}`);
                log('login-output', `é‚®ç®±: ${data.user.email}`);
                log('login-output', `é‚®ç®±ç¡®è®¤: ${data.user.email_confirmed_at ? 'æ˜¯' : 'å¦'}`);
                
                // æ£€æŸ¥profile
                setTimeout(checkProfile, 1000);
            } catch (error) {
                log('login-output', `ç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æ³¨å†Œ
        async function testRegister() {
            clear('login-output');
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            if (!email || !password) {
                log('login-output', 'è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }
            
            log('login-output', `å°è¯•æ³¨å†Œ: ${email}`);
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password
                });
                
                if (error) throw error;
                
                log('login-output', 'æ³¨å†ŒæˆåŠŸï¼', 'success');
                log('login-output', `ç”¨æˆ·ID: ${data.user?.id}`);
                log('login-output', 'è¯·æ£€æŸ¥é‚®ç®±éªŒè¯é‚®ä»¶', 'warning');
            } catch (error) {
                log('login-output', `æ³¨å†Œå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•ç™»å‡º
        async function testLogout() {
            log('login-output', '\nå°è¯•ç™»å‡º...');
            
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                log('login-output', 'ç™»å‡ºæˆåŠŸ', 'success');
            } catch (error) {
                log('login-output', `ç™»å‡ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 5. æ£€æŸ¥ä¼šè¯
        async function checkSession() {
            clear('session-output');
            log('session-output', 'æ£€æŸ¥å½“å‰ä¼šè¯...');
            
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) throw error;
                
                if (session) {
                    log('session-output', 'âœ… å·²ç™»å½•', 'success');
                    log('session-output', `ç”¨æˆ·ID: ${session.user.id}`);
                    log('session-output', `é‚®ç®±: ${session.user.email}`);
                    log('session-output', `Tokenè¿‡æœŸ: ${new Date(session.expires_at * 1000).toLocaleString()}`);
                } else {
                    log('session-output', 'æœªç™»å½•', 'warning');
                }
            } catch (error) {
                log('session-output', `é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æ£€æŸ¥Profile
        async function checkProfile() {
            log('session-output', '\næ£€æŸ¥ç”¨æˆ·Profile...');
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    log('session-output', 'è¯·å…ˆç™»å½•', 'warning');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        log('session-output', 'âŒ Profileä¸å­˜åœ¨', 'error');
                        log('session-output', 'å¯ä»¥ç‚¹å‡»"åˆ›å»ºProfile"æŒ‰é’®', 'info');
                    } else {
                        throw error;
                    }
                } else {
                    log('session-output', 'âœ… Profileå­˜åœ¨', 'success');
                    log('session-output', JSON.stringify(data, null, 2));
                }
            } catch (error) {
                log('session-output', `é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // åˆ›å»ºProfile
        async function createProfile() {
            log('session-output', '\nå°è¯•åˆ›å»ºProfile...');
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    log('session-output', 'è¯·å…ˆç™»å½•', 'warning');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('user_profiles')
                    .insert([{
                        user_id: user.id,
                        role: 'USER',
                        status: 'ACTIVE'
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                
                log('session-output', 'âœ… Profileåˆ›å»ºæˆåŠŸï¼', 'success');
                log('session-output', JSON.stringify(data, null, 2));
            } catch (error) {
                log('session-output', `åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 6. æ£€æŸ¥è§¦å‘å™¨
        async function checkTriggers() {
            clear('trigger-output');
            log('trigger-output', 'æ£€æŸ¥æ•°æ®åº“è§¦å‘å™¨...');
            log('trigger-output', 'æ³¨æ„: éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½æŸ¥çœ‹è§¦å‘å™¨', 'warning');
        }

        // 7. å®Œæ•´è¯Šæ–­
        async function runFullDiagnosis() {
            clear('full-output');
            log('full-output', '========== å¼€å§‹å®Œæ•´ç³»ç»Ÿè¯Šæ–­ ==========\n');
            
            const output = document.getElementById('full-output');
            
            // 1. ç¯å¢ƒ
            log('full-output', 'ã€1/6ã€‘ç¯å¢ƒé…ç½®æ£€æŸ¥');
            log('full-output', `âœ… Supabase URL: ${SUPABASE_URL}`, 'success');
            
            // 2. è¿æ¥
            log('full-output', '\nã€2/6ã€‘è¿æ¥æµ‹è¯•');
            try {
                await supabase.auth.getSession();
                log('full-output', 'âœ… Supabaseè¿æ¥æ­£å¸¸', 'success');
            } catch (e) {
                log('full-output', `âŒ è¿æ¥å¤±è´¥: ${e.message}`, 'error');
            }
            
            // 3. è¡¨æ£€æŸ¥
            log('full-output', '\nã€3/6ã€‘æ•°æ®åº“è¡¨æ£€æŸ¥');
            const tables = ['user_profiles', 'creator_profiles'];
            for (const table of tables) {
                try {
                    const { count } = await supabase.from(table).select('*', { count: 'exact', head: true });
                    log('full-output', `âœ… ${table}: ${count} æ¡è®°å½•`, 'success');
                } catch (e) {
                    log('full-output', `âŒ ${table}: ${e.message}`, 'error');
                }
            }
            
            // 4. ä¼šè¯æ£€æŸ¥
            log('full-output', '\nã€4/6ã€‘ä¼šè¯çŠ¶æ€');
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                log('full-output', `âœ… å·²ç™»å½•: ${session.user.email}`, 'success');
                
                // 5. Profileæ£€æŸ¥
                log('full-output', '\nã€5/6ã€‘Profileæ£€æŸ¥');
                const { data: profile, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        log('full-output', 'âŒ Profileä¸å­˜åœ¨ - éœ€è¦åˆ›å»º', 'error');
                    } else {
                        log('full-output', `âŒ Profileé”™è¯¯: ${error.message}`, 'error');
                    }
                } else {
                    log('full-output', 'âœ… Profileæ­£å¸¸', 'success');
                    log('full-output', `   è§’è‰²: ${profile.role}`);
                    log('full-output', `   çŠ¶æ€: ${profile.status}`);
                }
            } else {
                log('full-output', 'âš ï¸ æœªç™»å½•', 'warning');
            }
            
            // 6. æ€»ç»“
            log('full-output', '\nã€6/6ã€‘è¯Šæ–­æ€»ç»“');
            log('full-output', '========================================');
            
            if (!session) {
                log('full-output', 'é—®é¢˜: ç”¨æˆ·æœªç™»å½•', 'error');
                log('full-output', 'å»ºè®®: è¯·å…ˆç™»å½•æˆ–æ³¨å†Œè´¦å·', 'info');
            } else if (error && error.code === 'PGRST116') {
                log('full-output', 'é—®é¢˜: Profileæœªåˆ›å»º', 'error');
                log('full-output', 'å»ºè®®: ç‚¹å‡»"åˆ›å»ºProfile"æŒ‰é’®æˆ–æ£€æŸ¥è§¦å‘å™¨', 'info');
            } else {
                log('full-output', 'âœ… ç³»ç»ŸçŠ¶æ€æ­£å¸¸ï¼', 'success');
            }
        }
    </script>
</body>
</html>
