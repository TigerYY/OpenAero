<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Authé…ç½®æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-ok { color: #10b981; }
        .status-warning { color: #f59e0b; }
        .status-error { color: #ef4444; }
        .loading { 
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸš€ Supabase Authé…ç½®æµ‹è¯•</h1>
            <p class="text-gray-600">éªŒè¯Supabaseè®¤è¯æœåŠ¡çš„é…ç½®å’ŒåŠŸèƒ½çŠ¶æ€</p>
        </div>

        <!-- é…ç½®çŠ¶æ€ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ“‹ é…ç½®çŠ¶æ€</h2>
            <div id="configStatus" class="space-y-2">
                <div class="loading"></div>
                <span class="text-gray-600">æ­£åœ¨æ£€æŸ¥é…ç½®...</span>
            </div>
        </div>

        <!-- åŠŸèƒ½æµ‹è¯• -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ§ª åŠŸèƒ½æµ‹è¯•</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-medium mb-2">æ•°æ®åº“è¿æ¥</h3>
                    <div id="dbStatus" class="text-sm">ç­‰å¾…æµ‹è¯•...</div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-medium mb-2">è®¤è¯æœåŠ¡</h3>
                    <div id="authStatus" class="text-sm">ç­‰å¾…æµ‹è¯•...</div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-medium mb-2">ç”¨æˆ·è¡¨</h3>
                    <div id="tableStatus" class="text-sm">ç­‰å¾…æµ‹è¯•...</div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-medium mb-2">åŠŸèƒ½æ ‡å¿—</h3>
                    <div id="flagsStatus" class="text-sm">ç­‰å¾…æµ‹è¯•...</div>
                </div>
            </div>

            <div class="flex space-x-4">
                <button onclick="testConfiguration()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                    ğŸ”„ é‡æ–°æµ‹è¯•
                </button>
                <button onclick="enableSupabaseAuth()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition">
                    âœ… å¯ç”¨Supabase Auth
                </button>
                <button onclick="resetFlags()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 transition">
                    ğŸ”„ é‡ç½®æ ‡å¿—
                </button>
            </div>
        </div>

        <!-- æµ‹è¯•ç”¨æˆ·æ³¨å†Œ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ‘¤ æµ‹è¯•ç”¨æˆ·æ³¨å†Œ</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <input type="email" id="testEmail" placeholder="æµ‹è¯•é‚®ç®±" 
                       class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       value="test@example.com">
                <input type="password" id="testPassword" placeholder="æµ‹è¯•å¯†ç " 
                       class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                       value="test123456">
            </div>
            <button onclick="testUserRegistration()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600 transition">
                ğŸ§ª æµ‹è¯•æ³¨å†Œ
            </button>
            <div id="registrationResult" class="mt-4"></div>
        </div>

        <!-- é…ç½®å»ºè®® -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ’¡ é…ç½®å»ºè®®</h2>
            <div id="recommendations" class="space-y-2">
                <div class="loading"></div>
                <span class="text-gray-600">æ­£åœ¨ç”Ÿæˆå»ºè®®...</span>
            </div>
        </div>

        <!-- ä¸‹ä¸€æ­¥æ“ä½œ -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ</h2>
            <div id="nextSteps" class="space-y-2">
                <div class="loading"></div>
                <span class="text-gray-600">æ­£åœ¨ç”Ÿæˆæ“ä½œæŒ‡å—...</span>
            </div>
        </div>
    </div>

    <script>
        let currentConfig = null;

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        document.addEventListener('DOMContentLoaded', testConfiguration);

        async function testConfiguration() {
            showLoading();
            
            try {
                const response = await fetch('/api/test-supabase-auth');
                const data = await response.json();
                
                if (!response.ok) {
                    showError(data.error || 'Failed to test configuration');
                    return;
                }
                
                currentConfig = data;
                displayResults(data);
                
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        }

        function showLoading() {
            document.getElementById('configStatus').innerHTML = '<div class="loading"></div><span class="text-gray-600">æ­£åœ¨æ£€æŸ¥é…ç½®...</span>';
            document.getElementById('dbStatus').textContent = 'ç­‰å¾…æµ‹è¯•...';
            document.getElementById('authStatus').textContent = 'ç­‰å¾…æµ‹è¯•...';
            document.getElementById('tableStatus').textContent = 'ç­‰å¾…æµ‹è¯•...';
            document.getElementById('flagsStatus').textContent = 'ç­‰å¾…æµ‹è¯•...';
            document.getElementById('recommendations').innerHTML = '<div class="loading"></div><span class="text-gray-600">æ­£åœ¨ç”Ÿæˆå»ºè®®...</span>';
            document.getElementById('nextSteps').innerHTML = '<div class="loading"></div><span class="text-gray-600">æ­£åœ¨ç”Ÿæˆæ“ä½œæŒ‡å—...</span>';
        }

        function displayResults(data) {
            // æ˜¾ç¤ºé…ç½®çŠ¶æ€
            const configItems = [
                { label: 'Supabase URL', value: data.environment.hasSupabaseUrl ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®' },
                { label: 'Anonymous Key', value: data.environment.hasAnonKey ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®' },
                { label: 'Service Role Key', value: data.environment.hasServiceKey ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®' },
                { label: 'Google OAuth', value: data.environment.hasOAuthGoogle ? 'âœ… å·²é…ç½®' : 'âšª æœªé…ç½®' },
                { label: 'GitHub OAuth', value: data.environment.hasOAuthGitHub ? 'âœ… å·²é…ç½®' : 'âšª æœªé…ç½®' },
                { label: 'SMTPæœåŠ¡', value: data.environment.hasSMTP ? 'âœ… å·²é…ç½®' : 'âšª æœªé…ç½®' },
            ];
            
            document.getElementById('configStatus').innerHTML = configItems.map(item => 
                `<div class="flex justify-between py-1"><span>${item.label}:</span><span>${item.value}</span></div>`
            ).join('');

            // æ˜¾ç¤ºåŠŸèƒ½æµ‹è¯•ç»“æœ
            document.getElementById('dbStatus').innerHTML = data.configuration.database.connected ? 
                '<span class="status-ok">âœ… è¿æ¥æ­£å¸¸</span>' : '<span class="status-error">âŒ è¿æ¥å¤±è´¥</span>';
            
            document.getElementById('authStatus').innerHTML = data.configuration.auth.serviceAvailable ? 
                '<span class="status-ok">âœ… æœåŠ¡å¯ç”¨</span>' : '<span class="status-error">âŒ æœåŠ¡ä¸å¯ç”¨</span>';
            
            document.getElementById('tableStatus').innerHTML = data.configuration.database.userTableExists ? 
                '<span class="status-ok">âœ… è¡¨å·²å­˜åœ¨</span>' : '<span class="status-warning">âš ï¸ è¡¨ä¸å­˜åœ¨</span>';
            
            const flags = data.configuration.featureFlags;
            const flagsHtml = Object.entries(flags).map(([key, value]) => 
                `<div>${key}: <span class="${value ? 'status-ok' : 'status-warning'}">${value ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></div>`
            ).join('');
            document.getElementById('flagsStatus').innerHTML = flagsHtml;

            // æ˜¾ç¤ºå»ºè®®
            if (data.recommendations.length > 0) {
                document.getElementById('recommendations').innerHTML = data.recommendations.map(rec => 
                    `<div class="flex items-start space-x-2"><span class="text-yellow-500">ğŸ’¡</span><span>${rec}</span></div>`
                ).join('');
            } else {
                document.getElementById('recommendations').innerHTML = '<div class="status-ok">âœ… é…ç½®çœ‹èµ·æ¥å¾ˆå®Œæ•´ï¼</div>';
            }

            // æ˜¾ç¤ºä¸‹ä¸€æ­¥æ“ä½œ
            document.getElementById('nextSteps').innerHTML = data.nextSteps.map(step => 
                `<div class="flex items-start space-x-2"><span class="text-blue-500">ğŸ“‹</span><span>${step}</span></div>`
            ).join('');
        }

        async function enableSupabaseAuth() {
            if (!confirm('ç¡®å®šè¦å¯ç”¨Supabase Authå—ï¼Ÿè¿™å°†åˆ‡æ¢è®¤è¯ç³»ç»Ÿã€‚')) {
                return;
            }

            try {
                const response = await fetch('/api/test-supabase-auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'enable-supabase-auth' })
                });

                const data = await response.json();
                
                if (response.ok) {
                    alert('âœ… Supabase Authå·²æˆåŠŸå¯ç”¨ï¼');
                    testConfiguration(); // é‡æ–°æµ‹è¯•é…ç½®
                } else {
                    alert('âŒ å¯ç”¨å¤±è´¥: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }

        async function testUserRegistration() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            const resultDiv = document.getElementById('registrationResult');
            
            if (!email || !password) {
                resultDiv.innerHTML = '<div class="status-error">âŒ è¯·å¡«å†™é‚®ç®±å’Œå¯†ç </div>';
                return;
            }

            resultDiv.innerHTML = '<div class="loading"></div><span class="text-gray-600">æ­£åœ¨æµ‹è¯•æ³¨å†Œ...</span>';

            try {
                const response = await fetch('/api/test-supabase-auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'test-auth-flow',
                        email,
                        password 
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 p-4 rounded-lg">
                            <div class="status-ok">âœ… æµ‹è¯•ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼</div>
                            <div class="text-sm mt-2">
                                <div>ç”¨æˆ·ID: ${data.user.id}</div>
                                <div>é‚®ç®±: ${data.user.email}</div>
                                <div>é‚®ç®±å·²éªŒè¯: ${data.user.emailConfirmed ? 'æ˜¯' : 'å¦'}</div>
                            </div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="status-error">âŒ æ³¨å†Œå¤±è´¥: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="status-error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            }
        }

        async function resetFlags() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰åŠŸèƒ½æ ‡å¿—å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch('/api/test-supabase-auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'reset-flags' })
                });

                const data = await response.json();
                
                if (response.ok) {
                    alert('âœ… åŠŸèƒ½æ ‡å¿—å·²é‡ç½®');
                    testConfiguration();
                } else {
                    alert('âŒ é‡ç½®å¤±è´¥: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('âŒ ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }

        function showError(message) {
            document.getElementById('configStatus').innerHTML = `<div class="status-error">âŒ ${message}</div>`;
        }
    </script>
</body>
</html>