# 功能模块: 用户认证与管理

**功能ID**: user-auth  
**版本**: 1.2.0  
**日期**: 2025-10-23  
**状态**: [✅ 已完成]  
**优先级**: P0  
**类别**: 核心  
**依赖**: 无  
**最后更新**: 2025-10-23

## 概述

### 描述
具有多因素认证支持和全面用户配置文件管理的安全用户认证系统，为OpenAero平台提供基础。

### 业务价值
为所有用户提供安全访问平台的能力，保护敏感数据，并为基于角色的访问控制和用户管理提供基础。

### 用户影响
用户可以安全地注册、登录和管理其账户，确信其数据受到保护且访问得到适当控制。

## 需求

### 功能需求
- **FR-001**: 用户可以使用邮箱和密码注册
- **FR-002**: 用户可以使用凭据安全登录
- **FR-003**: 支持多因素认证
- **FR-004**: 密码重置功能正常工作
- **FR-005**: 可以创建和更新用户配置文件
- **FR-006**: 实现了基于角色的访问控制

### 非功能需求
- **NFR-001**: 认证响应时间<500ms
- **NFR-002**: 使用bcrypt进行密码哈希(最少12轮)
- **NFR-003**: JWT令牌24小时后过期
- **NFR-004**: 速率限制: 15分钟内5次失败尝试

## 验收标准

### 主要标准
- [x] 用户可以使用邮箱和密码注册
- [x] 用户可以使用MFA支持安全登录
- [x] 密码重置功能正常工作
- [x] 可以创建和更新用户配置文件
- [x] 实现了基于角色的访问控制

### 次要标准
- [x] 社交登录集成(Google, GitHub)
- [x] 会话管理和超时
- [x] 失败尝试后账户锁定
- [x] 新账户邮箱验证

## 技术规范

### 架构
认证系统使用Next.js API路由构建，使用JWT令牌，与NextAuth.js集成用于会话管理和OAuth提供商。

### 数据模型
```typescript
interface User {
  id: string;
  email: string;
  password: string; // 已哈希
  name: string;
  role: 'creator' | 'client' | 'admin';
  emailVerified: boolean;
  createdAt: Date;
  updatedAt: Date;
}

interface Session {
  user: User;
  expires: Date;
  token: string;
}
```

### API规范
- **POST /api/auth/register** - 用户注册
- **POST /api/auth/login** - 用户登录
- **POST /api/auth/logout** - 用户登出
- **POST /api/auth/reset-password** - 密码重置
- **GET /api/auth/session** - 获取当前会话
- **PUT /api/auth/profile** - 更新用户配置文件

### 数据库模式
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,
  name VARCHAR(255) NOT NULL,
  role VARCHAR(50) DEFAULT 'client',
  email_verified BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### 外部依赖
- **NextAuth.js**: 认证框架
- **bcryptjs**: 密码哈希
- **jsonwebtoken**: JWT令牌管理
- **nodemailer**: 验证邮件发送

## 实施详情

### 开发任务
- [x] 设置NextAuth.js配置
- [x] 实现用户注册API
- [x] 实现用户登录API
- [x] 添加bcrypt密码哈希
- [x] 实现JWT令牌管理
- [x] 添加TOTP的MFA支持
- [x] 创建用户配置文件管理
- [x] 实现基于角色的访问控制
- [x] 添加密码重置功能
- [x] 集成OAuth提供商

### 测试策略
- **单元测试**: 个别认证功能
- **集成测试**: API端点测试
- **端到端测试**: 完整的用户注册和登录流程
- **安全测试**: 渗透测试和漏洞扫描

### 性能考虑
- JWT令牌是无状态的，便于扩展
- 密码哈希使用12轮bcrypt
- 速率限制防止暴力攻击
- 会话数据在Redis中缓存

### 安全考虑
- 所有密码使用bcrypt哈希
- JWT令牌已签名和验证
- 速率限制防止滥用
- 输入验证和清理
- 所有认证端点的HTTPS强制

## 用户故事

### 主要用户故事
**作为**平台用户，**我希望**安全地注册和登录到我的账户，**以便**我可以访问平台功能并保护我的数据。

**验收场景**:
1. **给定**我是新用户，**当**我使用有效邮箱和密码注册时，**然后**我收到验证邮件并可以登录
2. **给定**我有一个账户，**当**我使用正确凭据登录时，**然后**我被认证并重定向到仪表板

### 次要用户故事
**作为**用户，**我希望**如果我忘记密码可以重置它，**以便**我可以重新获得账户访问权限。

**作为**用户，**我希望**启用双因素认证，**以便**我的账户更安全。

## 实施状态

### 当前状态
✅ **已完成** - 所有认证功能已实施并测试。

### 已完成项目
- [x] 带邮箱验证的用户注册
- [x] 带密码验证的安全登录
- [x] 多因素认证(TOTP)
- [x] 密码重置功能
- [x] 用户配置文件管理
- [x] 基于角色的访问控制
- [x] OAuth集成(Google, GitHub)
- [x] 会话管理
- [x] 安全测试和审计

### 进行中项目
- [ ] 无

### 阻塞项目
- [ ] 无

### 下一步
- [ ] 监控认证指标
- [ ] 根据需要实施其他OAuth提供商
- [ ] 根据用户反馈增强安全功能

## 测试

### 测试用例
| 测试ID | 描述 | 预期结果 | 状态 |
|--------|------|----------|------|
| TC-001 | 使用有效数据注册用户 | 账户创建，发送验证邮件 | ✅ 通过 |
| TC-002 | 使用正确凭据登录用户 | 成功认证 | ✅ 通过 |
| TC-003 | 使用错误密码登录用户 | 认证失败，应用速率限制 | ✅ 通过 |
| TC-004 | 密码重置流程 | 发送重置邮件，密码更新 | ✅ 通过 |
| TC-005 | MFA设置和验证 | TOTP代码生成和验证 | ✅ 通过 |

### 测试结果
所有认证测试通过。安全审计完成，未发现关键问题。

## 风险和缓解

### 已识别风险
- **风险1**: JWT令牌泄露 - **缓解**: 短令牌过期，安全存储
- **风险2**: 暴力攻击 - **缓解**: 速率限制和账户锁定
- **风险3**: 密码重用 - **缓解**: 密码强度要求

### 假设
- 用户将使用强密码
- 邮件传递可靠
- OAuth提供商维护安全标准

## 依赖

### 内部依赖
- 无(基础功能)

### 外部依赖
- **NextAuth.js**: 认证框架
- **邮件服务**: 用于验证和密码重置邮件
- **OAuth提供商**: Google, GitHub用于社交登录

## 审查历史

### 技术审查
- **日期**: 2025-10-23
- **审查者**: 安全团队
- **状态**: ✅ 已批准
- **评论**: 安全实施满足所有要求

### 业务审查
- **日期**: 2025-10-23
- **审查者**: 产品经理
- **状态**: ✅ 已批准
- **评论**: 用户体验满足业务要求

## 指标和KPI

### 成功指标
- **注册成功率**: 95%+成功注册
- **登录成功率**: 98%+成功登录
- **密码重置成功**: 90%+成功重置
- **MFA采用率**: 60%+用户启用MFA

### 性能指标
- **认证响应时间**: <500ms平均
- **密码哈希时间**: <100ms每次哈希
- **令牌生成时间**: <50ms每个令牌

## 文档

### 相关文档
- [API文档](../contracts/api-specification.md)
- [安全指南](../../security-guidelines.md)

### API文档
- [认证API端点](../../api/auth-endpoints.md)

### 用户文档
- [用户认证指南](../../user-guides/authentication.md)

---

**文档控制**:
- **创建**: 2025-10-23
- **最后修改**: 2025-10-23
- **版本**: 1.2.0
- **下次审查**: 2025-11-23
- **所有者**: 安全团队
