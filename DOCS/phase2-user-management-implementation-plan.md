# 阶段2：用户管理体系完善实施计划

## 概述

本文档详细规划了用户管理体系完善的实施计划，包括个人信息管理、密码管理、用户状态和权限管理、邮箱管理四个主要部分。

## 1.2 个人信息管理

### 1.2.1 评估个人信息页面功能 ✅

**当前状态**：
- ✅ 个人信息显示页面存在 (`src/app/[locale]/(dashboard)/profile/page.tsx`)
- ✅ 基本信息编辑功能（displayName, bio）已实现
- ✅ API端点存在 (`src/app/api/users/me/route.ts`)
- ⚠️ 头像上传按钮存在但未实现功能
- ⚠️ 手机号码字段未显示和编辑
- ⚠️ firstName和lastName未在表单中显示和编辑

**需要完善**：
1. 在个人信息表单中添加 firstName、lastName、phone 字段
2. 更新 API schema 支持 phone 字段
3. 实现头像上传功能

### 1.2.2 实现个人信息修改功能

**任务**：
- [ ] 完善姓名修改功能（firstName, lastName, displayName）
- [ ] 实现手机号码修改功能
- [ ] 添加个人信息修改的验证和错误处理
- [ ] 实现个人信息修改的审计日志（已实现）

**实施步骤**：
1. 更新 `src/app/api/users/me/route.ts` 的 schema，添加 `phone` 字段
2. 更新 `src/app/[locale]/(dashboard)/profile/page.tsx`，添加 firstName、lastName、phone 字段的表单
3. 使用统一的错误处理和响应格式

### 1.2.3 实现头像上传功能

**任务**：
- [ ] 创建头像上传API端点
- [ ] 实现头像图片上传和存储（Supabase Storage）
- [ ] 实现头像图片裁剪和压缩（可选，使用客户端库）
- [ ] 实现头像预览和更新功能
- [ ] 添加头像上传的验证（文件类型、大小限制）

**实施步骤**：
1. 创建 `src/app/api/users/me/avatar/route.ts` API端点
2. 使用 Supabase Storage 存储头像
3. 在前端添加头像上传组件
4. 实现图片预览和裁剪功能

### 1.2.4 实现密码修改功能

**任务**：
- [ ] 创建密码修改API端点（需要旧密码验证）
- [ ] 实现密码修改页面和表单
- [ ] 添加密码强度验证
- [ ] 实现密码修改成功后的会话刷新
- [ ] 添加密码修改的审计日志和安全通知

**实施步骤**：
1. 创建 `src/app/api/auth/change-password/route.ts` API端点
2. 创建 `src/app/[locale]/(dashboard)/settings/change-password/page.tsx` 页面
3. 使用统一的错误处理和密码强度验证组件

### 1.2.5 实现账户设置功能

**任务**：
- [ ] 完善语言设置功能（中英文切换）- 保存到用户偏好
- [ ] 实现时区设置功能 - 保存到用户偏好
- [ ] 实现通知偏好设置（邮件通知开关）- 保存到数据库
- [ ] 实现隐私设置（个人资料可见性）- 保存到数据库
- [ ] 实现账户删除功能（软删除）

**实施步骤**：
1. 创建用户偏好设置表（如果不存在）
2. 创建设置保存API端点
3. 更新设置页面，实现保存功能
4. 实现账户删除功能

## 1.3 密码管理

### 1.3.1 评估忘记密码流程 ✅

**当前状态**：
- ✅ 忘记密码页面存在
- ✅ 密码重置邮件发送功能已实现
- ✅ 审计日志已实现

### 1.3.2 完善密码重置流程

**当前状态**：
- ✅ 密码重置页面存在
- ✅ 基础密码强度检查已实现
- ⚠️ 密码强度验证不够严格（需要与注册时一致）

**需要完善**：
1. 统一密码强度验证规则
2. 使用统一的错误处理组件
3. 改进用户体验

### 1.3.3 添加密码强度验证

**任务**：
- [ ] 实现完整的密码强度检查规则（长度、大小写、数字、特殊字符）
- [ ] 添加密码强度实时显示（弱/中/强）
- [ ] 在注册和密码修改时强制密码强度要求
- [ ] 添加密码强度验证的前端和后端双重检查

**实施步骤**：
1. 统一密码强度验证逻辑（使用 `InputSanitizer.validatePassword`）
2. 在密码修改页面使用 `PasswordStrengthIndicator` 组件
3. 更新密码重置页面使用统一的密码强度验证

### 1.3.4 实现密码安全增强（可选，延后）

**任务**：
- [ ] 实现密码历史记录（防止重复使用最近N个密码）
- [ ] 实现密码过期提醒（可选）
- [ ] 实现密码修改频率限制

**状态**：延后实施

## 1.4 用户状态和权限管理

### 1.4.1 实现用户状态管理

**当前状态**：
- ✅ 用户状态枚举已定义（ACTIVE, INACTIVE, SUSPENDED, DELETED）
- ⚠️ 用户状态变更API需要管理员权限验证
- ⚠️ 用户状态变更的通知需要实现

**任务**：
- [ ] 检查用户状态枚举（ACTIVE, INACTIVE, SUSPENDED, DELETED）
- [ ] 实现用户状态变更API（管理员操作）
- [ ] 实现用户状态变更的审计日志
- [ ] 实现用户状态变更的通知（邮件通知用户）
- [ ] 检查不同状态用户的访问限制

**实施步骤**：
1. 检查现有管理员API中的用户状态管理功能
2. 完善用户状态变更API，添加通知功能
3. 实现不同状态用户的访问限制中间件

### 1.4.2 实现用户权限管理

**当前状态**：
- ✅ 用户角色枚举已定义（USER, CREATOR, REVIEWER, FACTORY_MANAGER, ADMIN, SUPER_ADMIN）
- ✅ 角色权限检查中间件已部分实现（`requireAdminAuth`）

**任务**：
- [ ] 检查用户角色枚举
- [ ] 实现角色权限检查中间件（完善）
- [ ] 实现角色变更API（管理员操作）
- [ ] 实现权限变更的审计日志
- [ ] 检查不同角色的功能访问权限

**实施步骤**：
1. 创建统一的角色权限检查工具函数
2. 完善角色变更API
3. 实现权限变更的审计日志

### 1.4.3 实现用户会话管理

**任务**：
- [ ] 检查Supabase会话管理功能
- [ ] 实现会话列表查看功能（用户查看自己的活跃会话）
- [ ] 实现会话终止功能（用户主动登出其他设备）
- [ ] 实现异常会话检测和通知（新设备登录、异常IP等）
- [ ] 实现会话超时和自动刷新机制

**实施步骤**：
1. 创建会话管理API端点
2. 创建会话管理页面
3. 实现异常会话检测逻辑

### 1.4.4 添加用户活动日志

**当前状态**：
- ✅ 审计日志系统已存在（AuditLog表）

**任务**：
- [ ] 检查审计日志系统（AuditLog表）
- [ ] 实现用户活动日志查看功能（用户查看自己的活动历史）
- [ ] 实现关键操作的日志记录（登录、密码修改、个人信息修改等）
- [ ] 实现活动日志的筛选和搜索功能
- [ ] 实现活动日志的导出功能（可选）

**实施步骤**：
1. 创建用户活动日志API端点
2. 创建用户活动日志页面
3. 实现筛选和搜索功能

## 1.5 邮箱管理

### 1.5.1 实现邮箱修改功能

**任务**：
- [ ] 创建邮箱修改API端点（需要密码验证）
- [ ] 实现邮箱修改流程（发送验证邮件到新邮箱）
- [ ] 实现邮箱修改确认功能
- [ ] 添加邮箱修改的审计日志和安全通知

**实施步骤**：
1. 创建 `src/app/api/auth/change-email/route.ts` API端点
2. 创建邮箱修改页面
3. 实现邮箱验证流程

### 1.5.2 完善邮箱验证

**当前状态**：
- ✅ 重新发送验证邮件功能已实现（`src/app/api/auth/resend-verification/route.ts`）

**任务**：
- [ ] 实现邮箱验证状态检查
- [ ] 实现重新发送验证邮件功能（已实现）
- [ ] 实现邮箱验证过期处理
- [ ] 添加未验证邮箱的功能限制提示

**实施步骤**：
1. 完善邮箱验证状态检查
2. 实现邮箱验证过期处理
3. 添加未验证邮箱的功能限制

## 实施优先级

### 高优先级（立即实施）
1. 1.2.2 完善个人信息修改功能（firstName, lastName, phone）
2. 1.2.4 实现密码修改功能
3. 1.3.3 添加密码强度验证
4. 1.5.1 实现邮箱修改功能

### 中优先级（后续实施）
1. 1.2.3 实现头像上传功能
2. 1.2.5 实现账户设置功能
3. 1.4.1 实现用户状态管理
4. 1.4.2 实现用户权限管理

### 低优先级（可选）
1. 1.4.3 实现用户会话管理
2. 1.4.4 添加用户活动日志
3. 1.3.4 实现密码安全增强

## 技术要点

1. **统一错误处理**：所有API端点使用统一的响应格式和错误处理
2. **审计日志**：所有关键操作都需要记录审计日志
3. **安全验证**：敏感操作（密码修改、邮箱修改）需要额外验证
4. **国际化支持**：所有用户界面文本支持中英文
5. **用户体验**：提供清晰的反馈和友好的错误提示

