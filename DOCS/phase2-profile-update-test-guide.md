# 个人信息更新功能测试指南

## 概述

本文档提供了测试个人信息更新功能的详细指南，包括手动测试步骤和自动化测试脚本。

## 测试范围

### 1. API 端点测试

**端点**: `PATCH /api/users/me`

**测试场景**:

1. **未认证请求**
   - 预期: 返回 401 未授权错误
   - 测试: 不提供认证 token

2. **Schema 验证测试**
   - `first_name`: 测试空字符串、过长字符串（>50字符）
   - `last_name`: 测试空字符串、过长字符串（>50字符）
   - `display_name`: 测试空字符串、过长字符串（>100字符）
   - `bio`: 测试过长字符串（>500字符）
   - `phone`: 测试无效格式（如 "invalid-phone"）
   - `avatar`: 测试无效 URL（如 "not-a-url"）

3. **有效数据测试**
   - 更新单个字段
   - 更新多个字段
   - 更新 phone 字段（存储在 auth.users 中）

4. **响应格式测试**
   - 验证使用统一响应格式（`createSuccessResponse`, `createErrorResponse`）
   - 验证验证错误使用 `createValidationErrorResponse`

### 2. 前端页面测试

**页面**: `/profile`

**测试场景**:

1. **页面加载**
   - 验证用户信息正确显示
   - 验证 firstName、lastName、phone 字段显示
   - 验证邮箱验证状态显示

2. **编辑模式**
   - 点击"编辑"按钮进入编辑模式
   - 验证所有字段可编辑
   - 验证字段错误提示显示

3. **表单验证**
   - 测试客户端验证（实时反馈）
   - 测试服务器端验证错误显示
   - 测试字段级错误提示

4. **提交测试**
   - 测试成功提交
   - 测试失败处理
   - 测试加载状态显示

5. **取消编辑**
   - 测试取消按钮重置表单
   - 测试取消后不保存更改

## 手动测试步骤

### 步骤 1: 启动开发服务器

```bash
npm run dev
```

### 步骤 2: 登录系统

1. 访问 `http://localhost:3000/zh-CN/login`
2. 使用有效账号登录

### 步骤 3: 访问个人信息页面

1. 导航到 `/zh-CN/profile`
2. 验证页面正确加载
3. 检查用户信息显示

### 步骤 4: 测试编辑功能

1. 点击"编辑"按钮
2. 修改各个字段：
   - 名字: "测试"
   - 姓氏: "用户"
   - 显示名称: "测试用户"
   - 手机号码: "+86 138 0013 8000"
   - 个人简介: "这是一个测试简介"
3. 点击"保存更改"
4. 验证成功消息显示
5. 验证数据已更新

### 步骤 5: 测试验证错误

1. 进入编辑模式
2. 测试各种无效输入：
   - 名字留空
   - 名字超过50字符
   - 手机号码格式错误
   - 个人简介超过500字符
3. 验证错误提示正确显示
4. 验证提交被阻止

### 步骤 6: 测试 phone 字段更新

1. 在编辑模式下修改手机号码
2. 提交更改
3. 验证 phone 字段正确更新（存储在 auth.users 中）
4. 刷新页面验证数据持久化

## API 测试脚本

使用提供的测试脚本进行 API 测试：

```bash
node scripts/test-profile-update.js
```

**注意**: 脚本需要有效的认证 token。可以通过以下方式获取：

1. 在浏览器中登录
2. 打开开发者工具 > Network 标签页
3. 查看 `/api/users/me` 请求的 Headers
4. 复制 `Authorization` header 的值
5. 修改测试脚本添加该 header

## 预期行为

### 成功响应

```json
{
  "success": true,
  "data": {
    "id": "user-id",
    "email": "user@example.com",
    "phone": "+86 138 0013 8000",
    "profile": {
      "first_name": "测试",
      "last_name": "用户",
      "display_name": "测试用户",
      "bio": "这是一个测试简介"
    }
  },
  "message": "用户信息更新成功"
}
```

### 验证错误响应

```json
{
  "success": false,
  "error": "验证失败",
  "details": {
    "first_name": ["名字不能为空"],
    "phone": ["无效的手机号码格式"]
  },
  "code": 400
}
```

### 未授权响应

```json
{
  "success": false,
  "error": "未授权访问",
  "code": 401
}
```

## 检查清单

- [ ] API 端点正确响应
- [ ] Schema 验证正常工作
- [ ] 统一响应格式正确
- [ ] 审计日志正确记录
- [ ] 前端页面正确显示
- [ ] 编辑功能正常工作
- [ ] 字段验证正确显示
- [ ] 成功/错误消息正确显示
- [ ] phone 字段正确更新
- [ ] 数据持久化正确

## 已知问题

1. **TypeScript 错误**: `src/app/[locale]/shop/products/[slug]/page.tsx` 存在语法错误（不影响当前功能测试）

## 下一步

完成测试后，继续实施：
1. 密码修改功能
2. 密码强度验证统一
3. 邮箱修改功能

